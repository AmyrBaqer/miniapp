<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</title>
  <style>
    body {
      margin: 0;
      font-family: 'Vazirmatn', sans-serif;
      background: #f8f9fa;
      direction: rtl;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 1px solid #ccc;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .tab {
      flex: 1;
      padding: 12px 5px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      color: #666;
    }
    .tab.active {
      background: #e0f7fa;
      color: #00796b;
      font-weight: bold;
    }
    #tab-content {
      padding: 20px;
      margin-bottom: 60px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
    }
    button {
      background: #00796b;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="tab-content">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">ğŸ’° Ù‚ÛŒÙ…Øª Ø§Ø±Ø²</div>
  <div class="tab" onclick="showTab(1)">ğŸ“° Ø§Ø®Ø¨Ø§Ø±</div>
  <div class="tab" onclick="showTab(2)">ğŸ Ø±ÙØ±Ø§Ù„â€ŒÙ‡Ø§</div>
  <div class="tab" onclick="showTab(3)">ğŸ“„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</div>
  <div class="tab" onclick="showTab(4)">ğŸ‘› Ú©ÛŒÙ Ù¾ÙˆÙ„</div>
</div>

<script>
  let currentTab = 0;
  let savedUserId = null;

  document.addEventListener("DOMContentLoaded", () => {
    showTab(0);
  });

  function showTab(index) {
    currentTab = index;
    document.querySelectorAll(".tab").forEach((tab, i) => {
      tab.classList.toggle("active", i === index);
    });
    const content = document.getElementById("tab-content");

    if (index === 0) {
      content.innerHTML = "<p>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§...</p>";
      fetch("https://api.nobitex.ir/market/stats")
        .then(res => res.json())
        .then(data => {
          const coins = ['usdt', 'btc', 'eth', 'xrp', 'doge', 'ada', 'bnb', 'trx', 'ltc', 'dot'];
          content.innerHTML = `
            <h2>Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø±Ø²Ù‡Ø§</h2>
            <table style="width:100%;text-align:center;border-collapse:collapse">
              <thead><tr><th>Ù†Ø§Ù…</th><th>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)</th><th>ØªØºÛŒÛŒØ±Ø§Øª</th></tr></thead>
              <tbody>
                ${coins.map(c => {
                  const p = data.stats[c + '-irt'];
                  const change = parseFloat(p['dayChange']).toFixed(2);
                  return `<tr>
                    <td>${c.toUpperCase()}</td>
                    <td>${(+p['latest']).toLocaleString('fa-IR')}</td>
                    <td style="color:${change >= 0 ? 'green' : 'red'}">${change}%</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          `;
        }).catch(() => content.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§.</p>");

    } else if (index === 1) {
      content.innerHTML = "<p>Ø¨Ø®Ø´ Ø§Ø®Ø¨Ø§Ø± Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>";
    } else if ([2, 3, 4].includes(index)) {
      if (savedUserId) {
        handleUserTabs(index, savedUserId);
      } else {
        loadTelegramUser((userId) => {
          savedUserId = userId;
          handleUserTabs(index, userId);
        });
      }
    }
  }

  function handleUserTabs(index, userId) {
    const content = document.getElementById("tab-content");

    if (index === 2) {
      content.innerHTML = "<p>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>";
      fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          if (data && data.ref_code) {
            content.innerHTML = `
              <h2>Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§</h2>
              <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
              <p>Ø§Ù…ØªÛŒØ§Ø²: ${data.points}</p>
              <p>Ø§ÙØ±Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒØ´Ø¯Ù‡:</p>
              <ul>${data.invited.map(id => `<li>${id}</li>`).join('')}</ul>
            `;
          } else {
            content.innerHTML = "<p>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>";
          }
        }).catch(() => content.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§.</p>");

    } else if (index === 3) {
      content.innerHTML = `
        <h2>Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h2>
        <label>Ù…Ø¨Ù„Øº (USDT):</label>
        <input type="number" id="amount" />
        <label>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</label>
        <select id="due">
          ${[7,14,21,28].map(d => `<option value="${d}">${d} Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</option>`).join("")}
        </select>
        <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
        <textarea id="desc" rows="3"></textarea>
        <button onclick="submitContract('${userId}')">Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</button>
        <div id="contracts"></div>
      `;
      loadContracts(userId);

    } else if (index === 4) {
      content.innerHTML = "<p>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ú©ÛŒÙ Ù¾ÙˆÙ„...</p>";
      fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
        .then(res => res.json())
        .then(wallet => {
          if (wallet) {
            content.innerHTML = `
              <h2>Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§</h2>
              <p><strong>Ù…ÙˆØ¬ÙˆØ¯ÛŒ:</strong> ${wallet.balance} Ø§Ù…ØªÛŒØ§Ø²</p>
              <p><strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</strong> ${new Date(wallet.created_at).toLocaleString('fa-IR')}</p>
            `;
          } else {
            content.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©ÛŒÙ Ù¾ÙˆÙ„.</p>";
          }
        }).catch(() => content.innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.</p>");
    }
  }

  function loadContracts(userId) {
    fetch(`https://mnymaker-production.up.railway.app/contract/list?user_id=${userId}`)
      .then(res => res.json())
      .then(contracts => {
        const container = document.getElementById("contracts");
        if (contracts && contracts.length > 0) {
          container.innerHTML = `
            <h3>Ù„ÛŒØ³Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§</h3>
            <ul>${contracts.map(c => `
              <li>
                Ù…Ø¨Ù„Øº: ${c.amount} USDT | Ø³Ø±Ø±Ø³ÛŒØ¯: ${new Date(c.due_date).toLocaleDateString('fa-IR')}<br/>
                ØªÙˆØ¶ÛŒØ­: ${c.description}
              </li>
            `).join("")}</ul>
          `;
        } else {
          container.innerHTML = "<p>Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
        }
      });
  }

  function submitContract(userId) {
    const amount = document.getElementById("amount").value;
    const due = parseInt(document.getElementById("due").value);
    const desc = document.getElementById("desc").value;
    const dueDate = new Date(Date.now() + due * 86400000).toISOString();

    fetch("https://mnymaker-production.up.railway.app/contract/new", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        amount: parseFloat(amount),
        due_date: dueDate,
        description: desc
      }),
    }).then(res => {
      if (res.ok) {
        alert("Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
        loadContracts(userId);
      } else {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯.");
      }
    });
  }

  function loadTelegramUser(callback) {
    try {
      Telegram.WebApp.ready();
      const user = Telegram.WebApp.initDataUnsafe.user;
      callback(user.id);
    } catch {
      callback(prompt("Ù„Ø·ÙØ§ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"));
    }
  }
</script>

</body>
</html>