<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مینی‌اپ ارز دیجیتال</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      background: #121212;
      color: #fff;
      padding-bottom: 70px;
      direction: rtl;
    }
    .tab-container {
      width: 100%;
      position: relative;
      min-height: 100vh;
      overflow: hidden;
    }
    .tab-content {
      position: absolute;
      width: 100%;
      top: 0;
      left: 100%;
      opacity: 0;
      transition: all 0.5s ease-in-out; /* انیمیشن انتقال تب‌ها */
      padding: 16px;
    }
    .tab-content.active {
      left: 0;
      opacity: 1;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 100%;
      background: #1e1e1e;
      display: flex;
      flex-direction: row-reverse;
      border-top: 1px solid #333;
      z-index: 1000;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      cursor: pointer;
      color: #aaa;
      font-size: 12px;
      transition: background 0.3s, color 0.3s;
      border-radius: 12px 12px 0 0;
    }
    .tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 2px;
    }
    .tab.active {
      background: #00b894;
      color: #fff;
    }
    select, table, input, textarea, button {
      background: #222;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: right;
      border-bottom: 1px solid #444;
    }
    button {
      background: #00b894;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="tab-container">
    <div class="tab-content active" id="tab-0"></div>
    <div class="tab-content" id="tab-1"></div>
    <div class="tab-content" id="tab-2"></div>
    <div class="tab-content" id="tab-3"></div>
    <div class="tab-content" id="tab-4"></div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)"><i class="fas fa-coins"></i>قیمت</div>
    <div class="tab" onclick="switchTab(1)"><i class="fas fa-newspaper"></i>اخبار</div>
    <div class="tab" onclick="switchTab(2)"><i class="fas fa-user-friends"></i>رفرال</div>
    <div class="tab" onclick="switchTab(3)"><i class="fas fa-file-signature"></i>قرارداد</div>
    <div class="tab" onclick="switchTab(4)"><i class="fas fa-wallet"></i>کیف پول</div>
  </div>

  <script>
    let currentTab = 0;
    const loadedTabs = {};
    const tabEls = document.querySelectorAll('.tab-content');
    function switchTab(index) {
      if (index === currentTab) return;
      document.querySelectorAll('.tab').forEach((tab, i) =>
        tab.classList.toggle("active", i === index)
      );
      tabEls[currentTab].classList.remove("active");
      tabEls[index].classList.add("active");
      tabEls[index].style.transition = "all 0.5s ease-in-out"; // انیمیشن بین تب‌ها
      currentTab = index;
      if (!loadedTabs[index]) {
        loadTab(index);
        loadedTabs[index] = true;
      }
    }
    function saveContent(index, html) {
      sessionStorage.setItem("tab_" + index, html);
    }
    function loadTab(index) {
      const contentEl = document.getElementById(`tab-${index}`);
      if (index === 0) {
        contentEl.innerHTML = "<p>در حال بارگذاری...</p>";
        fetch("https://mnymaker-production.up.railway.app/crypto")
          .then(res => res.json())
          .then(data => {
            const options = data.map(c => `<option>${c.name}</option>`).join("");
            const table = `<table><thead><tr><th>نام</th><th>قیمت</th><th>تغییر ۲۴ساعته</th></tr></thead><tbody>` +
              data.map(c => `
                <tr>
                  <td>${c.name}</td>
                  <td>$${c.price}</td>
                  <td style="color:${c.change >= 0 ? "lightgreen" : "salmon"}">${c.change.toFixed(2)}%</td>
                </tr>`).join("") + "</tbody></table>";
            const html = `<label>انتخاب ارز:</label><select>${options}</select>${table}`;
            contentEl.innerHTML = html;
            saveContent(0, html);
          })
          .catch(() => contentEl.innerHTML = "<p>خطا در دریافت اطلاعات!</p>");
      }
      if (index === 1) {
        contentEl.innerHTML = "<p>در حال بارگذاری اخبار...</p>";
        fetch("https://amyrgit-production.up.railway.app/news")
          .then(res => res.json())
          .then(news => {
            const html = news.map(item => `
              <div style="margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px">
                <img src="${item.image}" style="max-width:100%;border-radius:12px" />
                <h3>${item.title}</h3>
                <p>${item.summary}</p>
                <a href="${item.link}" target="_blank" style="color:#00cec9">ادامه خبر</a>
              </div>`).join("");
            contentEl.innerHTML = html;
            saveContent(1, html);
          })
          .catch(() => contentEl.innerHTML = "<p>خطا در دریافت اخبار!</p>");
      }
      if (index === 2) {
        loadTelegramUser(userId => {
          contentEl.innerHTML = "<p>در حال دریافت اطلاعات...</p>";
          fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
            .then(res => res.json())
            .then(data => {
              if (data.ref_code) {
                const html = `
                  <h2>لینک دعوت شما</h2>
                  <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
                  <p>امتیاز شما: ${data.points}</p>
                  <p>افراد دعوت‌شده:</p>
                  <ul>${data.invited.map(id => `<li>${id}</li>`).join("")}</ul>`;
                contentEl.innerHTML = html;
                saveContent(2, html);
              } else contentEl.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
            })
            .catch(() => contentEl.innerHTML = "<p>خطا در دریافت داده‌ها!</p>");
        });
      }
      if (index === 3) {
        loadTelegramUser(userId => {
          const html = `
            <h2>ثبت قرارداد جدید</h2>
            <label>مبلغ (USDT):</label>
            <input type="number" id="amount" />
            <label>تاریخ پایان:</label>
            <select id="due">${[7, 14, 21, 28].map(d => `<option value="${d}">${d} روز</option>`).join("")}</select>
            <label>توضیحات:</label>
            <textarea id="desc" rows="3"></textarea>
            <button onclick="submitContract('${userId}')">ثبت قرارداد</button>
            <div id="contracts"></div>`;
          contentEl.innerHTML = html;
          loadContracts(userId);
        });
      }
      if (index === 4) {
        loadTelegramUser(userId => {
          contentEl.innerHTML = "<p>در حال دریافت کیف پول...</p>";
          fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
            .then(res => res.json())
            .then(wallet => {
              const html = wallet ? `
                <h2>کیف پول شما</h2>
                <p><strong>موجودی:</strong> ${wallet.balance} امتیاز</p>
                <p><strong>تاریخ ایجاد:</strong> ${new Date(wallet.created_at).toLocaleString("fa-IR")}</p>` : "<p>خطا در دریافت کیف پول.</p>";
              contentEl.innerHTML = html;
              saveContent(4, html);
            })
            .catch(() => contentEl.innerHTML = "<p>خطا در ارتباط با سرور.</p>");
        });
      }
    }

    function loadTelegramUser(callback) {
      if (window.Telegram && Telegram.WebApp.initDataUnsafe?.user) {
        callback(Telegram.WebApp.initDataUnsafe.user.id);
      } else {
        document.getElementById(`tab-${currentTab}`).innerHTML = "<p>این قابلیت تنها در محیط تلگرام فعال است.</p>";
      }
    }

    function submitContract(userId) {
      const amount = document.getElementById("amount").value;
      const due = document.getElementById("due").value;
      const desc = document.getElementById("desc").value;
      fetch("https://mnymaker-production.up.railway.app/contract/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, amount, due_days: due, description: desc })
      })
        .then(res => res.json())
        .then(() => switchTab(3))
        .catch(() => document.getElementById("contracts").innerHTML += "<p>خطا در ثبت قرارداد!</p>");
    }

    function loadContracts(userId) {
      fetch(`https://mnymaker-production.up.railway.app/contract/list?user_id=${userId}`)
        .then(res => res.json())
        .then(contracts => {
          const table = `
            <h2>لیست قراردادها</h2>
            <table><thead><tr><th>مبلغ</th><th>تاریخ</th><th>توضیحات</th><th>وضعیت</th></tr></thead><tbody>` +
            contracts.map(c => `
              <tr>
                <td>${c.amount} USDT</td>
                <td>${c.due_date}</td>
                <td>${c.description}</td>
                <td>${c.status}</td>
              </tr>`).join("") + "</tbody></table>";
          document.getElementById("contracts").innerHTML = table;
        })
        .catch(() => document.getElementById("contracts").innerHTML = "<p>خطا در دریافت لیست قراردادها!</p>");
    }

    window.onload = () => {
      loadTab(0);
    };
  </script>
</body>
</html>