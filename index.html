<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مینی‌اپ ارز دیجیتال</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      margin: 0;
      background: #121212;
      color: #fff;
      padding-bottom: 70px;
      direction: rtl;
      height: 100vh;
      overflow: hidden;
    }
    .tab-container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-start; }
    .tab-content {
      width: 100%;
      padding: 16px;
      text-align: center;
      display: none;
      overflow-y: auto;
      position: relative;
    }
    .tab-content.active { display: block; }
    .tabs {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 100%;
      background: #1e1e1e;
      display: flex;
      flex-direction: row-reverse;
      border-top: 1px solid #333;
      z-index: 1000;
      padding: 0.8px 0; /* Increased by 8% */
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      cursor: pointer;
      color: #aaa;
      font-size: 12.96px; /* Increased by 8% */
      transition: background 0.3s, color 0.3s;
      border-radius: 12px 12px 0 0;
    }
    .tab i {
      display: block;
      font-size: 20.9952px; /* Increased by 8% */
      margin-bottom: 2px;
    }
    .tab.active {
      background: #00b894;
      color: #fff;
      padding: 11.664px 0; /* Increased by 8% */
    }
    select, table, input, textarea, button {
      background: #222;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    table { border-collapse: collapse; margin-top: 10px; }
    th, td {
      padding: 8px;
      text-align: right;
      border-bottom: 1px solid #444;
    }
    button { background: #00b894; cursor: pointer; }
    .scrollable { max-height: 400px; overflow-y: auto; }
    .tradingview-widget-container {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="tab-container">
    <div class="tab-content active" id="tab-0"></div>
    <div class="tab-content" id="tab-1"></div>
    <div class="tab-content" id="tab-2"></div>
    <div class="tab-content" id="tab-3"></div>
    <div class="tab-content" id="tab-4"></div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)"><i class="fas fa-coins"></i>قیمت</div>
    <div class="tab" onclick="switchTab(1)"><i class="fas fa-newspaper"></i>اخبار</div>
    <div class="tab" onclick="switchTab(2)"><i class="fas fa-user-friends"></i>رفرال</div>
    <div class="tab" onclick="switchTab(3)"><i class="fas fa-file-signature"></i>قرارداد</div>
    <div class="tab" onclick="switchTab(4)"><i class="fas fa-wallet"></i>کیف پول</div>
  </div>

  <script>
    let currentTab = 0;
    const loadedTabs = {};
    const tabEls = document.querySelectorAll('.tab-content');

    function switchTab(index) {
      if (index === currentTab) return;
      document.querySelectorAll('.tab').forEach((tab, i) =>
        tab.classList.toggle("active", i === index)
      );
      tabEls[currentTab].classList.remove("active");
      tabEls[index].classList.add("active");
      currentTab = index;
      if (!loadedTabs[index]) {
        loadTab(index);
        loadedTabs[index] = true;
      }
    }

    function loadTab(index) {
      const contentEl = document.getElementById(`tab-${index}`);
      if (index === 0) {
        contentEl.innerHTML = `
          <label>انتخاب ارز:</label>
          <select id="currencySelect" onchange="updateTradingViewWidget(this.value)">
            <option value="BTC" selected>بیت‌کوین</option>
          </select>
          <div class="tradingview-widget-container">
            <div id="tradingview-widget"></div>
            <div class="tradingview-widget-copyright">
              <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                <span class="blue-text">Track all markets on TradingView</span>
              </a>
            </div>
          </div>
          <p>در حال بارگذاری...</p>`;
        initializeTradingViewWidget("BTC");
        fetch("https://mnymaker-production.up.railway.app/crypto")
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(data => {
            if (data && data.length > 0) {
              const options = data.map(c => `<option value="${c.symbol}">${c.name}</option>`).join("");
              const tableRows = data.map(c => `
                <tr>
                  <td>${c.name}</td>
                  <td>$${c.price}</td>
                  <td style="color:${c.change >= 0 ? "lightgreen" : "salmon"}">${c.change.toFixed(2)}%</td>
                </tr>`).join("");

              document.getElementById("currencySelect").innerHTML = `
                <option value="BTC" selected>بیت‌کوین</option>
                ${options}`;
              contentEl.innerHTML = `
                <label>انتخاب ارز:</label>
                <select id="currencySelect" onchange="updateTradingViewWidget(this.value)">
                  <option value="BTC" selected>بیت‌کوین</option>
                  ${options}
                </select>
                <div class="tradingview-widget-container">
                  <div id="tradingview-widget"></div>
                  <div class="tradingview-widget-copyright">
                    <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                      <span class="blue-text">Track all markets on TradingView</span>
                    </a>
                  </div>
                </div>
                <div class="scrollable">
                  <table>
                    <thead><tr><th>نام</th><th>قیمت</th><th>تغییر ۲۴ساعته</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                  </table>
                </div>`;
              initializeTradingViewWidget("BTC");
            } else {
              contentEl.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
            }
          })
          .catch(err => {
            console.error("Error fetching crypto data:", err);
            contentEl.innerHTML = "<p>خطا در دریافت اطلاعات!</p>";
          });
      }

      if (index === 1) {
        contentEl.innerHTML = "<p>در حال بارگذاری اخبار...</p>";
        fetch("https://amyrgit-production.up.railway.app/news")
          .then(res => res.json())
          .then(news => {
            if (news && news.length > 0) {
              const html = news.map(item => `
                <div style="margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px">
                  <img src="${item.image}" style="max-width:100%;border-radius:12px" />
                  <h3>${item.title}</h3>
                  <p>${item.summary}</p>
                  <a href="${item.link}" target="_blank" style="color:#00cec9">ادامه خبر</a>
                </div>`).join("");
              contentEl.innerHTML = html;
            } else {
              contentEl.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
            }
          })
          .catch(() => contentEl.innerHTML = "<p>خطا در دریافت اخبار!</p>");
      }

      if (index === 2) {
        loadTelegramUser(userId => {
          contentEl.innerHTML = "<p>در حال دریافت اطلاعات...</p>";
          fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
            .then(res => res.json())
            .then(data => {
              if (data.ref_code) {
                const html = `
                  <h2>لینک دعوت شما</h2>
                  <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
                  <p>امتیاز شما: ${data.points}</p>
                  <p>افراد دعوت‌شده:</p>
                  <ul>${data.invited.map(id => `<li>${id}</li>`).join("")}</ul>`;
                contentEl.innerHTML = html;
              } else contentEl.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
            })
            .catch(() => contentEl.innerHTML = "<p>خطا در دریافت داده‌ها!</p>");
        });
      }

      if (index === 3) {
        loadTelegramUser(userId => {
          const html = `
            <h2>ثبت قرارداد جدید</h2>
            <label>مبلغ (USDT):</label>
            <input type="number" id="amount" />
            <label>تاریخ پایان:</label>
            <select id="due">${[7, 14, 21, 28].map(d => `<option value="${d}">${d} روز</option>`).join("")}</select>
            <label>توضیحات:</label>
            <textarea id="desc" rows="3"></textarea>
            <button onclick="submitContract('${userId}')">ثبت قرارداد</button>
            <div id="contracts"></div>`;
          contentEl.innerHTML = html;
        });
      }

      if (index === 4) {
        loadTelegramUser(userId => {
          contentEl.innerHTML = "<p>در حال دریافت کیف پول...</p>";
          fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
            .then(res => res.json())
            .then(wallet => {
              const html = wallet ? `
                <h2>کیف پول شما</h2>
                <p><strong>موجودی:</strong> ${wallet.balance} امتیاز</p>
                <p><strong>تاریخ ایجاد:</strong> ${new Date(wallet.created_at).toLocaleString("fa-IR")}</p>` : "<p>خطا در دریافت کیف پول.</p>";
              contentEl.innerHTML = html;
            })
            .catch(() => contentEl.innerHTML = "<p>خطا در ارتباط با سرور.</p>");
        });
      }
    }

    function initializeTradingViewWidget(symbol) {
      const widgetContainer = document.getElementById("tradingview-widget");
      widgetContainer.innerHTML = ""; // Clear previous widget
      new TradingView.widget({
        interval: "1m",
        width: "100%",
        isTransparent: false,
        height: 400, // Set a fixed height for the widget
        symbol: symbol,
        showIntervalTabs: true,
        displayMode: "single",
        locale: "fa",
        colorTheme: "dark",
        container_id: "tradingview-widget"
      });
    }

    function updateTradingViewWidget(symbol) {
      initializeTradingViewWidget(symbol);
    }

    function loadTelegramUser(callback) {
      if (window.Telegram && Telegram.WebApp.initDataUnsafe?.user) {
        callback(Telegram.WebApp.initDataUnsafe.user.id);
      } else {
        document.getElementById(`tab-${currentTab}`).innerHTML = "<p>این قابلیت تنها در محیط تلگرام فعال است.</p>";
      }
    }

    window.onload = () => {
      loadTab(0);
    };
  </script>
</body>
</html>
``` 
