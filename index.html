<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مینی‌اپ ارز دیجیتال</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      margin: 0;
      background: #121212;
      color: #fff;
      padding-bottom: 70px;
      direction: rtl;
      height: 100vh;
      overflow: hidden;
    }
    .tab-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    .tab-content {
      width: 100%;
      padding: 16px;
      text-align: center;
      position: absolute;
      top: 0;
      right: 0;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      height: calc(100% - 60px);
      overflow-y: auto;
      background: #121212; /* Match background color */
    }
    .tab-content.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 100%;
      background: #1e1e1e;
      display: flex;
      flex-direction: row-reverse;
      border-top: 1px solid #333;
      z-index: 1000; /* Ensure drawer stays on top */
      padding: 0px 0;
      height: 70px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 0px 0;
      cursor: pointer;
      color: #aaa;
      font-size: 12.96px;
      transition: all 0.3s ease;
      border-radius: 12px 12px 0 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .tab i {
      display: block;
      font-size: 20.9952px;
      margin-bottom: 2px;
    }
    .tab.active {
      background: #00b894;
      color: #fff;
      padding: 11.664px 0;
      z-index: 1001; /* Ensure active tab stays above the drawer */
      position: relative; /* Create stacking context for active tab */
      transform: translateY(-5px);
      height: 108%; 
    }
    select, table, input, textarea, button {
      background: #222;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    .currency-select-container {
      display: flex;
      align-items: center;
      gap: 10px; /* Add spacing between label and dropdown */
      margin-bottom: 10px;
      margin-top: 0; /* Remove any top margin */
    }
    .currency-select-container label {
      margin: 0;
      white-space: nowrap;
      font-size: 130%; /* Increase font size by 30% */
      position: relative;
      top: -15%; /* Move label 15% higher */
    }
    .currency-select-container select {
      flex: 1; /* Allow dropdown to take remaining space */
    }
    select {
      text-align: center; /* Center-align dropdown text */
      direction: ltr; /* Set dropdown direction to left-to-right */
      font-size: 105%; /* Increase font size by 5% */
    }
    table { 
      border-collapse: collapse; 
      margin-top: 10px; 
      width: 100%;
      direction: ltr; /* Set table direction to left-to-right */
    }
    th {
      position: sticky; /* Make header row fixed */
      top: 0; /* Stick to the top of the container */
      background: #222; /* Match table background */
      z-index: 1; /* Ensure it stays above other rows */
    }
    th, td {
      padding: 8px;
      text-align: left; /* Align text in table cells to the left */
      border-bottom: 1px solid #444;
    }
    td:first-child {
      width: 40%; /* Reduced width for currency names by 20% */
    }
    td:nth-child(2), td:nth-child(3) {
      width: 30%; /* Increased width for prices and changes */
    }
    button { 
      background: #00b894; 
      cursor: pointer; 
      transition: opacity 0.3s;
    }
    button:hover {
      opacity: 0.9;
    }
    .scrollable { 
      max-height: 360px; 
      overflow-y: auto;
      margin-top: 0; /* Removed margin to bring it closer to the widget */
    }
    .tradingview-widget-container {
      width: 100%;
      height: 300px;
      margin-bottom: 0; /* Removed margin to eliminate spacing */
      border-radius: 12px;
      overflow: hidden;
    }
    #tradingview-widget {
      width: 100%;
      height: 100%;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
    .loading:after {
      content: " ";
      display: block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 3px solid #fff;
      border-color: #fff transparent #fff transparent;
      animation: loading 1.2s linear infinite;
    }
    @keyframes loading {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      color: #ff6b6b;
      padding: 10px;
      background: #2d2d2d;
      border-radius: 8px;
      margin: 10px 0;
    }
    /* Add styles for the language section in the wallet tab */
    .language-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #1e1e1e;
      border-radius: 12px;
    }
    .language-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .language-selector label {
      white-space: nowrap;
    }
  </style>
  <script>
    let appLanguage = 'fa'; // Default language

    const translations = {
      fa: {
        price: 'قیمت',
        news: 'اخبار',
        referral: 'رفرال',
        contract: 'قرارداد',
        wallet: 'کیف پول',
        selectLanguage: 'انتخاب زبان:',
        walletBalance: 'موجودی فعلی',
        points: 'امتیاز',
        recentTransactions: 'تراکنش‌های اخیر',
        deposit: 'واریز',
        withdraw: 'برداشت',
        noTransactions: 'تراکنشی یافت نشد',
        inviteLinkCopied: 'لینک دعوت کپی شد!',
        enterValidAmount: 'لطفاً مبلغ معتبر وارد کنید',
        registeringContract: 'در حال ثبت قرارداد...',
        contractRegistered: 'قرارداد با موفقیت ثبت شد!',
        noContracts: 'قرارداد فعالی وجود ندارد',
        fetchingMarketData: 'در حال دریافت اطلاعات بازار...',
        noMarketData: 'داده‌ای برای نمایش وجود ندارد',
        fetchingNews: 'در حال دریافت اخبار...',
        noNews: 'اخبار جدیدی یافت نشد',
        errorLoadingChart: 'خطا در نمایش نمودار',
        errorFetchingData: 'خطا در دریافت اطلاعات بازار',
        errorFetchingNews: 'خطا در دریافت اخبار',
        errorFetchingContracts: 'خطا در دریافت قراردادها',
        errorFetchingReferral: 'خطا در دریافت اطلاعات معرفی',
        errorConnectingServer: 'خطا در ارتباط با سرور',
      },
      en: {
        price: 'Price',
        news: 'News',
        referral: 'Referral',
        contract: 'Contract',
        wallet: 'Wallet',
        selectLanguage: 'Select Language:',
        walletBalance: 'Current Balance',
        points: 'Points',
        recentTransactions: 'Recent Transactions',
        deposit: 'Deposit',
        withdraw: 'Withdraw',
        noTransactions: 'No transactions found',
        inviteLinkCopied: 'Invite link copied!',
        enterValidAmount: 'Please enter a valid amount',
        registeringContract: 'Registering contract...',
        contractRegistered: 'Contract successfully registered!',
        noContracts: 'No active contracts',
        fetchingMarketData: 'Fetching market data...',
        noMarketData: 'No data available',
        fetchingNews: 'Fetching news...',
        noNews: 'No news found',
        errorLoadingChart: 'Error loading chart',
        errorFetchingData: 'Error fetching market data',
        errorFetchingNews: 'Error fetching news',
        errorFetchingContracts: 'Error fetching contracts',
        errorFetchingReferral: 'Error fetching referral data',
        errorConnectingServer: 'Error connecting to server',
      },
      es: {
        price: 'Precio',
        news: 'Noticias',
        referral: 'Referidos',
        contract: 'Contrato',
        wallet: 'Cartera',
        selectLanguage: 'Seleccionar idioma:',
        walletBalance: 'Saldo actual',
        points: 'Puntos',
        recentTransactions: 'Transacciones recientes',
        deposit: 'Depósito',
        withdraw: 'Retiro',
        noTransactions: 'No se encontraron transacciones',
        inviteLinkCopied: '¡Enlace de invitación copiado!',
        enterValidAmount: 'Por favor, ingrese una cantidad válida',
        registeringContract: 'Registrando contrato...',
        contractRegistered: '¡Contrato registrado con éxito!',
        noContracts: 'No hay contratos activos',
        fetchingMarketData: 'Obteniendo datos del mercado...',
        noMarketData: 'No hay datos disponibles',
        fetchingNews: 'Obteniendo noticias...',
        noNews: 'No se encontraron noticias',
        errorLoadingChart: 'Error al cargar el gráfico',
        errorFetchingData: 'Error al obtener datos del mercado',
        errorFetchingNews: 'Error al obtener noticias',
        errorFetchingContracts: 'Error al obtener contratos',
        errorFetchingReferral: 'Error al obtener datos de referencia',
        errorConnectingServer: 'Error al conectar con el servidor',
      },
      zh: {
        price: '价格',
        news: '新闻',
        referral: '推荐',
        contract: '合同',
        wallet: '钱包',
        selectLanguage: '选择语言:',
        walletBalance: '当前余额',
        points: '积分',
        recentTransactions: '最近交易',
        deposit: '存款',
        withdraw: '取款',
        noTransactions: '未找到交易',
        inviteLinkCopied: '邀请链接已复制！',
        enterValidAmount: '请输入有效金额',
        registeringContract: '注册合同中...',
        contractRegistered: '合同注册成功！',
        noContracts: '没有活跃的合同',
        fetchingMarketData: '获取市场数据中...',
        noMarketData: '没有可用数据',
        fetchingNews: '获取新闻中...',
        noNews: '未找到新闻',
        errorLoadingChart: '加载图表时出错',
        errorFetchingData: '获取市场数据时出错',
        errorFetchingNews: '获取新闻时出错',
        errorFetchingContracts: '获取合同时出错',
        errorFetchingReferral: '获取推荐数据时出错',
        errorConnectingServer: '连接服务器时出错',
      },
      hi: {
        price: 'कीमत',
        news: 'समाचार',
        referral: 'रेफरल',
        contract: 'अनुबंध',
        wallet: 'वॉलेट',
        selectLanguage: 'भाषा चुनें:',
        walletBalance: 'वर्तमान शेष',
        points: 'अंक',
        recentTransactions: 'हाल के लेन-देन',
        deposit: 'जमा',
        withdraw: 'निकासी',
        noTransactions: 'कोई लेन-देन नहीं मिला',
        inviteLinkCopied: 'आमंत्रण लिंक कॉपी किया गया!',
        enterValidAmount: 'कृपया एक मान्य राशि दर्ज करें',
        registeringContract: 'अनुबंध पंजीकृत किया जा रहा है...',
        contractRegistered: 'अनुबंध सफलतापूर्वक पंजीकृत!',
        noContracts: 'कोई सक्रिय अनुबंध नहीं',
        fetchingMarketData: 'बाजार डेटा प्राप्त कर रहा है...',
        noMarketData: 'कोई डेटा उपलब्ध नहीं',
        fetchingNews: 'समाचार प्राप्त कर रहा है...',
        noNews: 'कोई समाचार नहीं मिला',
        errorLoadingChart: 'चार्ट लोड करने में त्रुटि',
        errorFetchingData: 'बाजार डेटा प्राप्त करने में त्रुटि',
        errorFetchingNews: 'समाचार प्राप्त करने में त्रुटि',
        errorFetchingContracts: 'अनुबंध प्राप्त करने में त्रुटि',
        errorFetchingReferral: 'रेफरल डेटा प्राप्त करने में त्रुटि',
        errorConnectingServer: 'सर्वर से कनेक्ट करने में त्रुटि',
      },
      ar: {
        price: 'السعر',
        news: 'الأخبار',
        referral: 'الإحالة',
        contract: 'العقد',
        wallet: 'المحفظة',
        selectLanguage: 'اختر اللغة:',
        walletBalance: 'الرصيد الحالي',
        points: 'النقاط',
        recentTransactions: 'المعاملات الأخيرة',
        deposit: 'إيداع',
        withdraw: 'سحب',
        noTransactions: 'لم يتم العثور على معاملات',
        inviteLinkCopied: 'تم نسخ رابط الدعوة!',
        enterValidAmount: 'يرجى إدخال مبلغ صالح',
        registeringContract: 'جارٍ تسجيل العقد...',
        contractRegistered: 'تم تسجيل العقد بنجاح!',
        noContracts: 'لا توجد عقود نشطة',
        fetchingMarketData: 'جارٍ جلب بيانات السوق...',
        noMarketData: 'لا توجد بيانات متاحة',
        fetchingNews: 'جارٍ جلب الأخبار...',
        noNews: 'لم يتم العثور على أخبار',
        errorLoadingChart: 'خطأ في تحميل الرسم البياني',
        errorFetchingData: 'خطأ في جلب بيانات السوق',
        errorFetchingNews: 'خطأ في جلب الأخبار',
        errorFetchingContracts: 'خطأ في جلب العقود',
        errorFetchingReferral: 'خطأ في جلب بيانات الإحالة',
        errorConnectingServer: 'خطأ في الاتصال بالخادم',
      },
      ru: {
        price: 'Цена',
        news: 'Новости',
        referral: 'Реферал',
        contract: 'Контракт',
        wallet: 'Кошелек',
        selectLanguage: 'Выберите язык:',
        walletBalance: 'Текущий баланс',
        points: 'Очки',
        recentTransactions: 'Последние транзакции',
        deposit: 'Депозит',
        withdraw: 'Снять',
        noTransactions: 'Транзакции не найдены',
        inviteLinkCopied: 'Ссылка на приглашение скопирована!',
        enterValidAmount: 'Пожалуйста, введите действительную сумму',
        registeringContract: 'Регистрация контракта...',
        contractRegistered: 'Контракт успешно зарегистрирован!',
        noContracts: 'Активных контрактов нет',
        fetchingMarketData: 'Получение данных рынка...',
        noMarketData: 'Нет доступных данных',
        fetchingNews: 'Получение новостей...',
        noNews: 'Новостей не найдено',
        errorLoadingChart: 'Ошибка загрузки графика',
        errorFetchingData: 'Ошибка получения данных рынка',
        errorFetchingNews: 'Ошибка получения новостей',
        errorFetchingContracts: 'Ошибка получения контрактов',
        errorFetchingReferral: 'Ошибка получения данных рефералов',
        errorConnectingServer: 'Ошибка подключения к серверу',
      },
      pt: {
        price: 'Preço',
        news: 'Notícias',
        referral: 'Referência',
        contract: 'Contrato',
        wallet: 'Carteira',
        selectLanguage: 'Selecionar idioma:',
        walletBalance: 'Saldo atual',
        points: 'Pontos',
        recentTransactions: 'Transações recentes',
        deposit: 'Depósito',
        withdraw: 'Retirada',
        noTransactions: 'Nenhuma transação encontrada',
        inviteLinkCopied: 'Link de convite copiado!',
        enterValidAmount: 'Por favor, insira um valor válido',
        registeringContract: 'Registrando contrato...',
        contractRegistered: 'Contrato registrado com sucesso!',
        noContracts: 'Nenhum contrato ativo',
        fetchingMarketData: 'Obtendo dados do mercado...',
        noMarketData: 'Nenhum dado disponível',
        fetchingNews: 'Obtendo notícias...',
        noNews: 'Nenhuma notícia encontrada',
        errorLoadingChart: 'Erro ao carregar gráfico',
        errorFetchingData: 'Erro ao obter dados do mercado',
        errorFetchingNews: 'Erro ao obter notícias',
        errorFetchingContracts: 'Erro ao obter contratos',
        errorFetchingReferral: 'Erro ao obter dados de referência',
        errorConnectingServer: 'Erro ao conectar ao servidor',
      },
      fr: {
        price: 'Prix',
        news: 'Actualités',
        referral: 'Parrainage',
        contract: 'Contrat',
        wallet: 'Portefeuille',
        selectLanguage: 'Choisir la langue:',
        walletBalance: 'Solde actuel',
        points: 'Points',
        recentTransactions: 'Transactions récentes',
        deposit: 'Dépôt',
        withdraw: 'Retrait',
        noTransactions: 'Aucune transaction trouvée',
        inviteLinkCopied: 'Lien d\'invitation copié!',
        enterValidAmount: 'Veuillez entrer un montant valide',
        registeringContract: 'Enregistrement du contrat...',
        contractRegistered: 'Contrat enregistré avec succès!',
        noContracts: 'Aucun contrat actif',
        fetchingMarketData: 'Récupération des données du marché...',
        noMarketData: 'Aucune donnée disponible',
        fetchingNews: 'Récupération des actualités...',
        noNews: 'Aucune actualité trouvée',
        errorLoadingChart: 'Erreur de chargement du graphique',
        errorFetchingData: 'Erreur lors de la récupération des données du marché',
        errorFetchingNews: 'Erreur lors de la récupération des actualités',
        errorFetchingContracts: 'Erreur lors de la récupération des contrats',
        errorFetchingReferral: 'Erreur lors de la récupération des données de parrainage',
        errorConnectingServer: 'Erreur de connexion au serveur',
      },
    };

    function setLanguage(lang) {
      appLanguage = lang;
      document.documentElement.lang = lang;
      updateLanguageTexts();
    }

    function detectUserLanguage() {
      const userLang = navigator.language || navigator.userLanguage;
      const supportedLangs = ['fa', 'en', 'es', 'fr', 'de', 'zh', 'ar', 'ru', 'tr', 'ja'];
      const primaryLang = userLang.split('-')[0];

      if (supportedLangs.includes(primaryLang)) {
        setLanguage(primaryLang);
      } else {
        setLanguage('fa');
      }
    }

    function updateLanguageTexts() {
      const texts = translations[appLanguage];

      // Update tab labels
      document.querySelectorAll('.tab').forEach((tab, index) => {
        const labels = [texts.price, texts.news, texts.referral, texts.contract, texts.wallet];
        tab.querySelector('i').nextSibling.textContent = labels[index];
      });

      // Update wallet tab content
      if (currentTab === 4) {
        document.querySelector('.language-section label').textContent = texts.selectLanguage;
        document.getElementById('wallet-balance-label').textContent = texts.walletBalance;
        document.getElementById('recent-transactions-label').textContent = texts.recentTransactions;
        document.querySelector('.scrollable p').textContent = texts.noTransactions;

        document.querySelectorAll('button').forEach(button => {
          if (button.textContent.includes('واریز') || button.textContent.includes('Deposit')) {
            button.textContent = texts.deposit;
          }
          if (button.textContent.includes('برداشت') || button.textContent.includes('Withdraw')) {
            button.textContent = texts.withdraw;
          }
        });
      }

      // Update error messages dynamically
      document.querySelectorAll('.error-message').forEach(el => {
        if (el.textContent.includes('خطا در دریافت اطلاعات بازار') || el.textContent.includes('Error fetching market data')) {
          el.textContent = texts.errorFetchingData;
        }
        if (el.textContent.includes('خطا در دریافت اخبار') || el.textContent.includes('Error fetching news')) {
          el.textContent = texts.errorFetchingNews;
        }
        if (el.textContent.includes('خطا در دریافت قراردادها') || el.textContent.includes('Error fetching contracts')) {
          el.textContent = texts.errorFetchingContracts;
        }
        if (el.textContent.includes('خطا در ارتباط با سرور') || el.textContent.includes('Error connecting to server')) {
          el.textContent = texts.errorConnectingServer;
        }
      });

      // Update other static texts dynamically
      document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.getAttribute('data-translate-key');
        if (texts[key]) {
          el.textContent = texts[key];
        }
      });
    }
  </script>
</head>
<body onload="detectUserLanguage()">
  <div class="tab-container">
    <div class="tab-content active" id="tab-0">
      <div class="currency-select-container">
        <label data-translate-key="selectCurrency">${translations[appLanguage].selectCurrency || 'انتخاب ارز:'}</label>
        <select id="currencySelect" onchange="updateTradingViewWidget(this.value)">
          <option value="TON" selected>TonCoin</option>
        </select>
      </div>
      <div class="tradingview-widget-container">
        <div id="tradingview-widget"></div>
      </div>
      <div id="crypto-table-container" class="scrollable">
        <p data-translate-key="fetchingMarketData">${translations[appLanguage].fetchingMarketData || 'در حال دریافت اطلاعات بازار...'}</p>
      </div>
    </div>
    <div class="tab-content" id="tab-1">
      <div class="loading" data-translate-key="fetchingNews">${translations[appLanguage].fetchingNews || 'در حال دریافت اخبار...'}</div>
    </div>
    <div class="tab-content" id="tab-2">
      <h2 data-translate-key="referralSystem">${translations[appLanguage].referralSystem || 'سیستم معرفی دوستان'}</h2>
      <p data-translate-key="inviteLinkCopied">${translations[appLanguage].inviteLinkCopied || 'لینک دعوت کپی شد!'}</p>
    </div>
    <div class="tab-content" id="tab-3">
      <h2 data-translate-key="manageContracts">${translations[appLanguage].manageContracts || 'مدیریت قراردادها'}</h2>
      <label data-translate-key="amount">${translations[appLanguage].amount || 'مبلغ (USDT):'}</label>
      <label data-translate-key="dueDate">${translations[appLanguage].dueDate || 'تاریخ پایان:'}</label>
      <label data-translate-key="description">${translations[appLanguage].description || 'توضیحات:'}</label>
    </div>
    <div class="tab-content" id="tab-4">
      <div class="language-section">
        <div class="language-selector">
          <label data-translate-key="selectLanguage">${translations[appLanguage].selectLanguage || 'انتخاب زبان:'}</label>
          <select onchange="setLanguage(this.value)" style="flex:1">
            ${Object.keys(translations).map(
              lang => `<option value="${lang}" ${appLanguage === lang ? 'selected' : ''}>${translations[lang].selectLanguage}</option>`
            ).join('')}
          </select>
        </div>
      </div>
      <div style="background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <p id="wallet-balance-label" data-translate-key="walletBalance">${translations[appLanguage].walletBalance || 'موجودی فعلی'}</p>
        <p style="font-size: 32px; font-weight: bold; margin: 0; color: #00b894;">0 <span style="font-size: 16px;" data-translate-key="points">${translations[appLanguage].points || 'امتیاز'}</span></p>
      </div>
      <div style="background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <h3 id="recent-transactions-label" data-translate-key="recentTransactions">${translations[appLanguage].recentTransactions || 'تراکنش‌های اخیر'}</h3>
        <p data-translate-key="noTransactions">${translations[appLanguage].noTransactions || 'تراکنشی یافت نشد'}</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button style="flex: 1; background: #00b894;" data-translate-key="deposit">${translations[appLanguage].deposit || 'واریز'}</button>
        <button style="flex: 1; background: #fc5c65;" data-translate-key="withdraw">${translations[appLanguage].withdraw || 'برداشت'}</button>
      </div>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)"><i class="fas fa-coins"></i>قیمت</div>
    <div class="tab" onclick="switchTab(1)"><i class="fas fa-newspaper"></i>اخبار</div>
    <div class="tab" onclick="switchTab(2)"><i class="fas fa-user-friends"></i>رفرال</div>
    <div class="tab" onclick="switchTab(3)"><i class="fas fa-file-signature"></i>قرارداد</div>
    <div class="tab" onclick="switchTab(4)"><i class="fas fa-wallet"></i>کیف پول</div>
  </div>

  <script>
    let currentTab = 0;
    const loadedTabs = {};
    const tabEls = document.querySelectorAll('.tab-content');
    let tradingViewScriptLoaded = false;

    // تابع بارگذاری اسکریپت TradingView
    function loadTradingViewScript(callback) {
      if (typeof TradingView !== 'undefined') {
        tradingViewScriptLoaded = true;
        if (callback) callback();
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://s3.tradingview.com/tv.js';
      script.onload = () => {
        tradingViewScriptLoaded = true;
        if (callback) callback();
      };
      script.onerror = () => {
        console.error('Failed to load TradingView script');
        document.getElementById('tradingview-widget')?.insertAdjacentHTML('afterend', 
          '<p class="error-message">خطا در بارگذاری نمودار. لطفاً اتصال اینترنت را بررسی کنید.</p>');
      };
      document.body.appendChild(script);
    }

    // تابع ایجاد ویجت TradingView
    function initializeTradingViewWidget(symbol = 'TON') {
      if (!tradingViewScriptLoaded) {
        loadTradingViewScript(() => initializeTradingViewWidget(symbol));
        return;
      }

      const widgetContainer = document.getElementById("tradingview-widget");
      if (!widgetContainer) return;

      widgetContainer.innerHTML = '<div class="loading"></div>';

      try {
        new TradingView.widget({
          "autosize": false,
          "width": "100%",
          "height": 300,
          "symbol": `${symbol}USDT`,
          "interval": "4H",
          "timezone": "Asia/Tehran",
          "theme": "dark",
          "style": "2",
          "locale": "fa_IR",
          "toolbar_bg": "#1e1e1e",
          "enable_publishing": false,
          "hide_legend": true,
          "hide_top_toolbar": true,
          "hide_side_toolbar": true,
          "save_image": false,
          "allow_symbol_change": false,
          "hide_volume": true,
          "container_id": "tradingview-widget",
          "studies": [] // Removed "Volume" indicator
        });
      } catch (error) {
        console.error('TradingView error:', error);
        widgetContainer.innerHTML = '<p class="error-message">خطا در نمایش نمودار</p>';
      }
    }

    function updateTradingViewWidget(symbol) {
      if (typeof symbol !== 'string' || !symbol.trim()) {
        console.error('Invalid symbol:', symbol);
        return; // Exit if the symbol is not valid
      }
      initializeTradingViewWidget(symbol);
    }

    function switchTab(index) {
      if (index === currentTab) return;

      // Remove active class for the current tab content
      tabEls[currentTab].classList.remove("active");

      document.querySelectorAll('.tab').forEach((tab, i) =>
        tab.classList.toggle("active", i === index)
      );

      // Add active class for the new tab content after a slight delay
      setTimeout(() => {
        tabEls[index].classList.add("active");
      }, 50);

      currentTab = index;

      if (!loadedTabs[index]) {
        loadTab(index);
        loadedTabs[index] = true;
      }

      if (index === 1) {
        updateLanguageTexts(); // Update texts when switching to the "اخبار" tab
      }
    }

    function loadTab(index) {
      const contentEl = document.getElementById(`tab-${index}`);
      
      if (index === 0) {
        loadPriceTab(contentEl);
      } else if (index === 1) {
        loadNewsTab(contentEl);
      } else if (index === 2) {
        loadReferralTab(contentEl);
      } else if (index === 3) {
        loadContractTab(contentEl);
      } else if (index === 4) {
        loadWalletTab(contentEl);
      }
    }

    function loadPriceTab(contentEl) {
      contentEl.innerHTML = `
        <div class="currency-select-container">
          <label>انتخاب ارز:</label>
          <select id="currencySelect" onchange="updateTradingViewWidget(this.value)">
            <option value="TON" selected>TonCoin</option>
          </select>
        </div>
        <div class="tradingview-widget-container">
          <div id="tradingview-widget"></div>
        </div>
        <div id="crypto-table-container" class="scrollable">
          <p>در حال دریافت اطلاعات بازار...</p>
        </div>`;
      
      initializeTradingViewWidget("TON");

      // Fetch and display currencies
      fetch("https://mnymaker-production.up.railway.app/crypto")
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (data?.length > 0) {
            // Ensure data types are correct, remove duplicates, and exclude Tether (USDT)
            const uniqueCurrencies = Array.from(new Map(data.map(c => [c.symbol, c])).values())
              .filter(c => c.symbol !== "USDT" && typeof c.symbol === "string" && typeof c.name === "string" && typeof c.price === "number");

            const options = uniqueCurrencies.map(c => 
              `<option value="${c.symbol}">${c.name}</option>`
            ).join("");

            const tableRows = uniqueCurrencies.map(c => `
              <tr>
                <td>${c.name}</td>
                <td>$${c.price}</td>
                <td style="color:${c.change >= 0 ? "#28B463" : "#E74C3C"}">
                  ${c.change >= 0 ? '▲' : '▼'} ${Math.abs(c.change).toFixed(2)}%
                </td>
              </tr>`
            ).join("");

            document.getElementById("currencySelect").innerHTML = `
              <option value="TON" selected>TonCoin</option>
              ${options}`;

            document.getElementById("crypto-table-container").innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>نام ارز</th>
                    <th>$ قیمت</th>
                    <th>تغییر 24ساعت</th>
                  </tr>
                </thead>
                <tbody>${tableRows}</tbody>
              </table>`;
          } else {
            document.getElementById("crypto-table-container").innerHTML = 
              '<p class="error-message">داده‌ای برای نمایش وجود ندارد</p>';
          }
        })
        .catch(err => {
          console.error("Error fetching crypto data:", err);
          document.getElementById("crypto-table-container").innerHTML = 
            '<p class="error-message">خطا در دریافت اطلاعات بازار</p>';
        });
    }

    function loadNewsTab(contentEl) {
      contentEl.innerHTML = '<div class="loading"></div>';
      
      fetch("https://amyrgit-production.up.railway.app/news")
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(news => {
          if (news?.length > 0) {
            contentEl.innerHTML = news.map(item => `
              <div class="news-item" style="
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #333;
              ">
                <img src="${item.image || 'https://via.placeholder.com/300x150?text=No+Image'}" 
                  style="
                    width: 100%;
                    border-radius: 8px;
                    margin-bottom: 10px;
                  "
                  onerror="this.src='https://via.placeholder.com/300x150?text=No+Image'"
                />
                <h3 style="margin: 10px 0;">${item.title}</h3>
                <p style="color: #aaa; margin-bottom: 10px;">${item.summary}</p>
                <a href="${item.link}" target="_blank" style="
                  display: inline-block;
                  padding: 8px 15px;
                  background: #00b894;
                  color: white;
                  border-radius: 8px;
                  text-decoration: none;
                ">
                  ادامه خبر
                </a>
              </div>`
            ).join("");
          } else {
            contentEl.innerHTML = '<p class="error-message">اخبار جدیدی یافت نشد</p>';
          }
        })
        .catch(() => {
          contentEl.innerHTML = '<p class="error-message">خطا در دریافت اخبار</p>';
        });
    }

    function loadReferralTab(contentEl) {
      loadTelegramUser(userId => {
        contentEl.innerHTML = '<div class="loading"></div>';
        
        fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
          })
          .then(data => {
            if (data.ref_code) {
              contentEl.innerHTML = `
                <h2 style="margin-bottom: 15px;">سیستم معرفی دوستان</h2>
                
                <div style="
                  background: #1e1e1e;
                  padding: 15px;
                  border-radius: 12px;
                  margin-bottom: 20px;
                ">
                  <p style="margin: 0 0 10px 0;">لینک دعوت شما:</p>
                  <input 
                    value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" 
                    readonly
                    style="
                      background: #333;
                      color: white;
                      border: none;
                      padding: 10px;
                      width: 100%;
                      border-radius: 8px;
                      margin-bottom: 10px;
                    "
                  />
                  <button onclick="copyReferralLink()" style="
                    background: #00b894;
                    color: white;
                    border: none;
                    padding: 10px;
                    width: 100%;
                    border-radius: 8px;
                    cursor: pointer;
                  ">
                    کپی لینک
                  </button>
                </div>
                
                <div style="
                  background: #1e1e1e;
                  padding: 15px;
                  border-radius: 12px;
                  margin-bottom: 20px;
                ">
                  <p style="margin: 0 0 5px 0; font-size: 18px;">
                    امتیاز شما: <strong>${data.points || 0}</strong>
                  </p>
                  <p style="margin: 0; color: #aaa;">
                    هر دعوت موفق: +10 امتیاز
                  </p>
                </div>
                
                <div style="
                  background: #1e1e1e;
                  padding: 15px;
                  border-radius: 12px;
                ">
                  <h3 style="margin-top: 0;">افراد دعوت‌شده:</h3>
                  ${data.invited?.length > 0 ? 
                    `<ul style="padding-right: 20px;">${
                      data.invited.map(id => `<li style="margin-bottom: 5px;">${id}</li>`).join("")
                    }</ul>` : 
                    '<p style="color: #aaa;">هنوز کسی را دعوت نکرده‌اید</p>'
                  }
                </div>`;
            } else {
              contentEl.innerHTML = '<p class="error-message">خطا در دریافت اطلاعات معرفی</p>';
            }
          })
          .catch(() => {
            contentEl.innerHTML = '<p class="error-message">خطا در ارتباط با سرور</p>';
          });
      });
    }

    function loadContractTab(contentEl) {
      loadTelegramUser(userId => {
        contentEl.innerHTML = `
          <h2 style="margin-bottom: 20px;">مدیریت قراردادها</h2>
          
          <div style="
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
          ">
            <h3 style="margin-top: 0;">ثبت قرارداد جدید</h3>
            
            <label>مبلغ (USDT):</label>
            <input 
              type="number" 
              id="amount" 
              placeholder="مثال: 100"
            />
            
            <label>تاریخ پایان:</label>
            <select id="due">
              ${[7, 14, 21, 28].map(d => `
                <option value="${d}">${d} روز</option>
              `).join("")}
            </select>
            
            <label>توضیحات:</label>
            <textarea 
              id="desc" 
              rows="3" 
              placeholder="توضیحات قرارداد (اختیاری)"
            ></textarea>
            
            <button onclick="submitContract('${userId}')">
              ثبت قرارداد
            </button>
          </div>
          
          <div id="contracts-list" style="
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
          ">
            <h3 style="margin-top: 0;">قراردادهای فعال</h3>
            <p>در حال دریافت لیست قراردادها...</p>
          </div>`;
          
        // دریافت لیست قراردادها
        fetch(`https://mnymaker-production.up.railway.app/contracts?user_id=${userId}`)
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
          })
          .then(contracts => {
            const contractsList = document.getElementById("contracts-list");
            
            if (contracts?.length > 0) {
              contractsList.innerHTML = `
                <h3 style="margin-top: 0;">قراردادهای فعال</h3>
                <div class="scrollable">
                  <table>
                    <thead>
                      <tr>
                        <th>مبلغ</th>
                        <th>تاریخ پایان</th>
                        <th>وضعیت</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${contracts.map(c => `
                        <tr>
                          <td>${c.amount} USDT</td>
                          <td>${new Date(c.due_date).toLocaleDateString('fa-IR')}</td>
                          <td style="color: ${
                            c.status === 'active' ? '#26de81' : 
                            c.status === 'pending' ? '#f7b731' : '#fc5c65'
                          }">
                            ${
                              c.status === 'active' ? 'فعال' : 
                              c.status === 'pending' ? 'در انتظار' : 'پایان یافته'
                            }
                          </td>
                        </tr>
                      `).join("")}
                    </tbody>
                  </table>
                </div>`;
            } else {
              contractsList.innerHTML = '<p>قرارداد فعالی وجود ندارد</p>';
            }
          })
          .catch(() => {
            document.getElementById("contracts-list").innerHTML = 
              '<p class="error-message">خطا در دریافت قراردادها</p>';
          });
      });
    }

    function loadWalletTab(contentEl) {
      loadTelegramUser(userId => {
        contentEl.innerHTML = `
          <div class="language-section">
            <div class="language-selector">
              <label>${translations[appLanguage].selectLanguage}</label>
              <select onchange="setLanguage(this.value)" style="flex:1">
                ${Object.keys(translations).map(
                  lang => `<option value="${lang}" ${appLanguage === lang ? 'selected' : ''}>${translations[lang].selectLanguage}</option>`
                ).join('')}
              </select>
            </div>
          </div>
          <div style="background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
            <p id="wallet-balance-label" style="font-size: 14px; color: #aaa; margin-bottom: 5px;">${translations[appLanguage].walletBalance}</p>
            <p style="font-size: 32px; font-weight: bold; margin: 0; color: #00b894;">0 <span style="font-size: 16px;">${translations[appLanguage].points}</span></p>
          </div>
          <div style="background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <h3 id="recent-transactions-label" style="margin-top: 0;">${translations[appLanguage].recentTransactions}</h3>
            <p>تراکنشی یافت نشد</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button style="flex: 1; background: #00b894;">${translations[appLanguage].deposit}</button>
            <button style="flex: 1; background: #fc5c65;">${translations[appLanguage].withdraw}</button>
          </div>`;
      });
    }

    function loadTelegramUser(callback) {
      if (window.Telegram && Telegram.WebApp.initDataUnsafe?.user) {
        callback(Telegram.WebApp.initDataUnsafe.user.id);
      } else {
        // حالت آزمایشی - فقط برای توسعه
        const testUserId = Math.floor(Math.random() * 1000000);
        console.warn('Running in test mode with random user ID');
        callback(testUserId);
        // در حالت واقعی:
        // document.getElementById(`tab-${currentTab}`).innerHTML = 
        //   '<p class="error-message">این قابلیت تنها در محیط تلگرام فعال است</p>';
      }
    }

    function copyReferralLink() {
      const input = document.querySelector('#tab-2 input');
      if (input) {
        input.select();
        document.execCommand('copy');
        alert('لینک دعوت کپی شد!');
      }
    }

    function submitContract(userId) {
      const amount = document.getElementById('amount').value;
      const due = document.getElementById('due').value;
      const desc = document.getElementById('desc').value;
      
      if (!amount || isNaN(amount)) {
        alert('لطفاً مبلغ معتبر وارد کنید');
        return;
      }
      
      const contractsList = document.getElementById('contracts-list');
      contractsList.innerHTML = '<p>در حال ثبت قرارداد...</p>';
      
      // اینجا باید درخواست به سرور ارسال شود
      setTimeout(() => {
        contractsList.innerHTML = `
          <p style="color: #26de81;">قرارداد با موفقیت ثبت شد!</p>
          <div class="scrollable">
            <table>
              <thead>
                <tr>
                  <th>مبلغ</th>
                  <th>تاریخ پایان</th>
                  <th>وضعیت</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${amount} USDT</td>
                  <td>${new Date(Date.now() + due * 24 * 60 * 60 * 1000).toLocaleDateString('fa-IR')}</td>
                  <td style="color: #f7b731;">در انتظار تایید</td>
                </tr>
              </tbody>
            </table>
          </div>`;
      }, 1500);
    }

    // بارگذاری اولیه
    window.onload = () => {
      loadTradingViewScript();
      loadTab(0);
    };
  </script>
</body>
</html>