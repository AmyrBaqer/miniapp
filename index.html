<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مینی‌اپ ارز دیجیتال</title>
  <style>
    body {
      margin: 0;
      font-family: 'Vazirmatn', sans-serif;
      background: #f8f9fa;
      direction: rtl;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 1px solid #ccc;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .tab {
      flex: 1;
      padding: 12px 5px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      color: #666;
    }
    .tab.active {
      background: #e0f7fa;
      color: #00796b;
      font-weight: bold;
    }
    #tab-content {
      padding: 20px;
      margin-bottom: 60px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
    }
    button {
      background: #00796b;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="tab-content">در حال بارگذاری...</div>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">💰 قیمت ارز</div>
  <div class="tab" onclick="showTab(1)">📰 اخبار</div>
  <div class="tab" onclick="showTab(2)">🎁 رفرال‌ها</div>
  <div class="tab" onclick="showTab(3)">📄 قراردادها</div>
  <div class="tab" onclick="showTab(4)">👛 کیف پول</div>
</div>

<script>
  let currentTab = 0;
  let savedUserId = null;

  document.addEventListener("DOMContentLoaded", () => {
    showTab(0);
  });

  function showTab(index) {
    currentTab = index;
    document.querySelectorAll(".tab").forEach((tab, i) => {
      tab.classList.toggle("active", i === index);
    });
    const content = document.getElementById("tab-content");

    if (index === 0) {
      content.innerHTML = "<p>در حال دریافت قیمت‌ها...</p>";
      fetch("https://api.nobitex.ir/market/stats")
        .then(res => res.json())
        .then(data => {
          const coins = ['usdt', 'btc', 'eth', 'xrp', 'doge', 'ada', 'bnb', 'trx', 'ltc', 'dot'];
          content.innerHTML = `
            <h2>قیمت لحظه‌ای ارزها</h2>
            <table style="width:100%;text-align:center;border-collapse:collapse">
              <thead><tr><th>نام</th><th>قیمت (تومان)</th><th>تغییرات</th></tr></thead>
              <tbody>
                ${coins.map(c => {
                  const p = data.stats[c + '-irt'];
                  const change = parseFloat(p['dayChange']).toFixed(2);
                  return `<tr>
                    <td>${c.toUpperCase()}</td>
                    <td>${(+p['latest']).toLocaleString('fa-IR')}</td>
                    <td style="color:${change >= 0 ? 'green' : 'red'}">${change}%</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          `;
        }).catch(() => content.innerHTML = "<p>خطا در دریافت قیمت‌ها.</p>");

    } else if (index === 1) {
      content.innerHTML = "<p>بخش اخبار به زودی فعال می‌شود.</p>";
    } else if ([2, 3, 4].includes(index)) {
      if (savedUserId) {
        handleUserTabs(index, savedUserId);
      } else {
        loadTelegramUser((userId) => {
          savedUserId = userId;
          handleUserTabs(index, userId);
        });
      }
    }
  }

  function handleUserTabs(index, userId) {
    const content = document.getElementById("tab-content");

    if (index === 2) {
      content.innerHTML = "<p>در حال دریافت اطلاعات...</p>";
      fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          if (data && data.ref_code) {
            content.innerHTML = `
              <h2>لینک دعوت شما</h2>
              <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
              <p>امتیاز: ${data.points}</p>
              <p>افراد دعوت‌شده:</p>
              <ul>${data.invited.map(id => `<li>${id}</li>`).join('')}</ul>
            `;
          } else {
            content.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
          }
        }).catch(() => content.innerHTML = "<p>خطا در دریافت داده‌ها.</p>");

    } else if (index === 3) {
      content.innerHTML = `
        <h2>ثبت قرارداد جدید</h2>
        <label>مبلغ (USDT):</label>
        <input type="number" id="amount" />
        <label>تاریخ پایان:</label>
        <select id="due">
          ${[7,14,21,28].map(d => `<option value="${d}">${d} روز آینده</option>`).join("")}
        </select>
        <label>توضیحات:</label>
        <textarea id="desc" rows="3"></textarea>
        <button onclick="submitContract('${userId}')">ثبت قرارداد</button>
        <div id="contracts"></div>
      `;
      loadContracts(userId);

    } else if (index === 4) {
      content.innerHTML = "<p>در حال دریافت کیف پول...</p>";
      fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
        .then(res => res.json())
        .then(wallet => {
          if (wallet) {
            content.innerHTML = `
              <h2>کیف پول شما</h2>
              <p><strong>موجودی:</strong> ${wallet.balance} امتیاز</p>
              <p><strong>تاریخ ایجاد:</strong> ${new Date(wallet.created_at).toLocaleString('fa-IR')}</p>
            `;
          } else {
            content.innerHTML = "<p>خطا در دریافت کیف پول.</p>";
          }
        }).catch(() => content.innerHTML = "<p>خطا در ارتباط با سرور.</p>");
    }
  }

  function loadContracts(userId) {
    fetch(`https://mnymaker-production.up.railway.app/contract/list?user_id=${userId}`)
      .then(res => res.json())
      .then(contracts => {
        const container = document.getElementById("contracts");
        if (contracts && contracts.length > 0) {
          container.innerHTML = `
            <h3>لیست قراردادها</h3>
            <ul>${contracts.map(c => `
              <li>
                مبلغ: ${c.amount} USDT | سررسید: ${new Date(c.due_date).toLocaleDateString('fa-IR')}<br/>
                توضیح: ${c.description}
              </li>
            `).join("")}</ul>
          `;
        } else {
          container.innerHTML = "<p>قراردادی یافت نشد.</p>";
        }
      });
  }

  function submitContract(userId) {
    const amount = document.getElementById("amount").value;
    const due = parseInt(document.getElementById("due").value);
    const desc = document.getElementById("desc").value;
    const dueDate = new Date(Date.now() + due * 86400000).toISOString();

    fetch("https://mnymaker-production.up.railway.app/contract/new", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        amount: parseFloat(amount),
        due_date: dueDate,
        description: desc
      }),
    }).then(res => {
      if (res.ok) {
        alert("قرارداد با موفقیت ثبت شد!");
        loadContracts(userId);
      } else {
        alert("خطا در ثبت قرارداد.");
      }
    });
  }

  function loadTelegramUser(callback) {
    try {
      Telegram.WebApp.ready();
      const user = Telegram.WebApp.initDataUnsafe.user;
      callback(user.id);
    } catch {
      callback(prompt("لطفا آیدی عددی خود را وارد کنید:"));
    }
  }
</script>

</body>
</html>