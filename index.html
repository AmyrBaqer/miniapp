<!DOCTYPE html>
<html lang="fa">
  <head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8" />
    <title>مینی‌اپ ارز دیجیتال</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #121212;
        color: #fff;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        border-radius: 8px;
        background: #333;
        cursor: pointer;
      }
      .tab.active {
        background: #00b894;
      }
      .content {
        border-top: 1px solid #555;
        padding-top: 20px;
      }
      select,
      table,
      input,
      textarea {
        background: #222;
        color: #fff;
        border: none;
        padding: 10px;
        width: 100%;
        margin-bottom: 10px;
        border-radius: 8px;
      }
      table {
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #444;
      }
    </style>
  </head>
  <body>
    <h1>مینی‌اپ ارز دیجیتال</h1>
    <div class="tabs">
      <div class="tab active" onclick="showTab(0)">قیمت ارز</div>
      <div class="tab" onclick="showTab(1)">اخبار</div>
      <div class="tab" onclick="showTab(2)">رفرال ها</div>
      <div class="tab" onclick="showTab(3)">قرارداد ها</div>
      <div class="tab" onclick="showTab(4)">کیف پول</div>
    </div>
    <div class="content" id="tab-content">
      <!-- محتوای تب‌ها اینجا میاد -->
    </div>
    <script>
      let currentTab = 0;
      const apiUrl = "https://mnymaker-production.up.railway.app/crypto";
      function showTab(index) {
        currentTab = index;
        document.querySelectorAll(".tab").forEach((tab, i) => {
          tab.classList.toggle("active", i === index);
        });
        const content = document.getElementById("tab-content");

        if (index === 0) {
          content.innerHTML = "<p>در حال بارگذاری...</p>";
          fetch(apiUrl)
            .then((res) => res.json())
            .then((data) => {
              let options = data
                .map(
                  (coin) => `<option value="${coin.id}">${coin.name}</option>`
                )
                .join("");
              let table = `<table><thead><tr><th>نام</th><th>قیمت</th><th>تغییر ۲۴ساعته</th></tr></thead><tbody>`;
              table +=
                data
                  .map(
                    (coin) => `
              <tr>
                <td>${coin.name}</td>
                <td>$${coin.price}</td>
                <td style="color:${coin.change >= 0 ? "lightgreen" : "salmon"}">
                  ${coin.change.toFixed(2)}%
                </td>
              </tr>
            `
                  )
                  .join("") + "</tbody></table>";
              content.innerHTML = `
                <label>انتخاب ارز:</label>
                <select>${options}</select>
                ${table}
              `;
            })
            .catch(() => {
              content.innerHTML = "<p>خطا در دریافت اطلاعات!</p>";
            });
        } else if (index === 1) {
          content.innerHTML = "<p>در حال بارگذاری اخبار...</p>";
          fetch("https://amyrgit-production.up.railway.app/news")
            .then((res) => res.json())
            .then((news) => {
              let html = news
                .map(
                  (item) => `
        <div style="margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px">
          <img src="${item.image}" alt="${item.title}" style="max-width:100%;border-radius:12px;" />
          <h3 style="margin:10px 0;">${item.title}</h3>
          <p>${item.summary}</p>
          <a href="${item.link}" target="_blank" style="color:#00cec9">ادامه خبر</a>
        </div>
      `
                )
                .join("");
              content.innerHTML = html;
            })
            .catch(() => {
              content.innerHTML = "<p>خطا در دریافت اخبار!</p>";
            });
        } else if (index === 2) {
          loadTelegramUser((userId) => {
            content.innerHTML = "<p>در حال دریافت اطلاعات...</p>";
            fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
              .then((res) => res.json())
              .then((data) => {
                if (data && data.ref_code) {
                  content.innerHTML = `
            <h2>لینک دعوت شما</h2>
            <p>با دعوت دوستان امتیاز بگیرید!</p>
            <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
            <p>امتیاز شما: ${data.points}</p>
            <p>افراد دعوت‌شده:</p>
            <ul>${data.invited.map((id) => `<li>${id}</li>`).join("")}</ul>
          `;
                } else {
                  content.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
                }
              })
              .catch(() => {
                content.innerHTML = "<p>خطا در دریافت داده‌ها!</p>";
              });
          });
        } else if (index === 3) {
          loadTelegramUser((userId) => {
            content.innerHTML = `
              <h2>ثبت قرارداد جدید</h2>
              <label>مبلغ (USDT):</label>
              <input type="number" id="amount" />
              <label>تاریخ پایان:</label>
              <select id="due">
                ${[7, 14, 21, 28].map(d => `<option value="${d}">${d} روز آینده</option>`).join("")}
              </select>
              <label>توضیحات:</label>
              <textarea id="desc" rows="3"></textarea>
              <button onclick="submitContract('${userId}')" style="padding:10px 20px;background:#00b894;color:#fff;border:none;border-radius:8px;cursor:pointer">ثبت قرارداد</button>
              <div id="contracts"></div>
            `;
            loadContracts(userId);
          });
        } else if (index === 4) {
          loadTelegramUser((userId) => {
            content.innerHTML = "<p>در حال دریافت کیف پول...</p>";
            fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
              .then((res) => res.json())
              .then((wallet) => {
                if (wallet) {
                  content.innerHTML = `
                    <h2>کیف پول شما</h2>
                    <p><strong>موجودی:</strong> ${wallet.balance} امتیاز</p>
                    <p><strong>تاریخ ایجاد:</strong> ${new Date(wallet.created_at).toLocaleString("fa-IR")}</p>
                  `;
                } else {
                  content.innerHTML = "<p>خطا در دریافت کیف پول.</p>";
                }
              })
              .catch(() => {
                content.innerHTML = "<p>خطا در ارتباط با سرور.</p>";
              });
          });
        }
      }

      function loadTelegramUser(callback) {
        if (window.Telegram && window.Telegram.WebApp) {
          const userId = Telegram.WebApp.initDataUnsafe?.user?.id || "guest";
          callback(userId);
        } else {
          document.getElementById("tab-content").innerHTML = "<p>این قابلیت تنها در محیط تلگرام قابل استفاده است.</p>";
        }
      }

      function submitContract(userId) {
        const amount = document.getElementById("amount").value;
        const due = document.getElementById("due").value;
        const desc = document.getElementById("desc").value;
        fetch("https://mnymaker-production.up.railway.app/contract/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, amount, due_days: due, description: desc })
        })
          .then(res => res.json())
          .then(() => {
            showTab(3);
          })
          .catch(() => {
            document.getElementById("tab-content").innerHTML += "<p>خطا در ثبت قرارداد!</p>";
          });
      }

      function loadContracts(userId) {
        fetch(`https://mnymaker-production.up.railway.app/contract/list?user_id=${userId}`)
          .then(res => res.json())
          .then(contracts => {
            let table = `<h2>لیست قراردادها</h2><table><thead><tr><th>مبلغ</th><th>تاریخ پایان</th><th>توضیحات</th><th>وضعیت</th></tr></thead><tbody>`;
            table += contracts.map(c => `
              <tr>
                <td>${c.amount} USDT</td>
                <td>${c.due_date}</td>
                <td>${c.description}</td>
                <td>${c.status}</td>
              </tr>
            `).join("") + "</tbody></table>";
            document.getElementById("contracts").innerHTML = table;
          })
          .catch(() => {
            document.getElementById("contracts").innerHTML = "<p>خطا در دریافت لیست قراردادها!</p>";
          });
      }

      window.onload = () => showTab(0);
    </script>
  </body>
</html>
