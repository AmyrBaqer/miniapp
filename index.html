<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مینی‌اپ ارز دیجیتال</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script type="text/javascript" src="https://cdn.tradingview.com/tv.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      background: #121212;
      color: #fff;
      padding-bottom: 70px;
      direction: rtl;
    }
    .tab-container {
      width: 100%;
      position: relative;
      min-height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }
    .tab-content {
      position: absolute;
      width: 100%;
      top: 0;
      left: 100%;
      opacity: 0;
      transition: left 0.3s ease-out, opacity 0.3s ease-out;
      padding: 16px;
      text-align: center;
    }
    .tab-content.active {
      left: 0;
      opacity: 1;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 100%;
      background: #1e1e1e;
      display: flex;
      flex-direction: row-reverse;
      border-top: 1px solid #333;
      z-index: 1000;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      cursor: pointer;
      color: #aaa;
      font-size: 12px;
      transition: background 0.3s, color 0.3s;
      border-radius: 12px 12px 0 0;
    }
    .tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 2px;
    }
    .tab.active {
      background: #00b894;
      color: #fff;
    }
    select, table, input, textarea, button {
      background: #222;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: right;
      border-bottom: 1px solid #444;
    }
    button {
      background: #00b894;
      cursor: pointer;
    }
    .scrollable {
      max-height: 400px;
      overflow-y: auto;
    }
    .chart-container {
      width: 100%;
      height: 300px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="tab-container">
    <div class="tab-content active" id="tab-0"></div>
    <div class="tab-content" id="tab-1"></div>
    <div class="tab-content" id="tab-2"></div>
    <div class="tab-content" id="tab-3"></div>
    <div class="tab-content" id="tab-4"></div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)"><i class="fas fa-coins"></i>قیمت</div>
    <div class="tab" onclick="switchTab(1)"><i class="fas fa-newspaper"></i>اخبار</div>
    <div class="tab" onclick="switchTab(2)"><i class="fas fa-user-friends"></i>رفرال</div>
    <div class="tab" onclick="switchTab(3)"><i class="fas fa-file-signature"></i>قرارداد</div>
    <div class="tab" onclick="switchTab(4)"><i class="fas fa-wallet"></i>کیف پول</div>
  </div>

  <script>
    let currentTab = 0;
    const loadedTabs = {};
    const tabEls = document.querySelectorAll('.tab-content');
    
    function switchTab(index) {
      if (index === currentTab) return;
      
      // حذف کلاس active از تب قبلی
      document.querySelectorAll('.tab').forEach((tab, i) =>
        tab.classList.toggle("active", i === index)
      );
      tabEls[currentTab].classList.remove("active");
      tabEls[index].classList.add("active");
      currentTab = index;

      // بارگذاری محتوا برای تب جدید
      if (!loadedTabs[index]) {
        loadTab(index);
        loadedTabs[index] = true;
      }
    }
    
    function loadTab(index) {
      const contentEl = document.getElementById(`tab-${index}`);
      if (index === 0) {
        contentEl.innerHTML = "<p>در حال بارگذاری...</p>";
        fetch("https://mnymaker-production.up.railway.app/crypto")
          .then(res => res.json())
          .then(data => {
            const options = data.map(c => `<option value="${c.symbol}">${c.name}</option>`).join("");
            const table = `
              <label>انتخاب ارز:</label>
              <select id="currencySelect">${options}</select>
              <div class="chart-container" id="chartContainer"></div>
              <div class="scrollable">
                <table><thead><tr><th>نام</th><th>قیمت</th><th>تغییر ۲۴ساعته</th></tr></thead><tbody>` +
              data.map(c => `
                <tr>
                  <td>${c.name}</td>
                  <td>$${c.price}</td>
                  <td style="color:${c.change >= 0 ? "lightgreen" : "salmon"}">${c.change.toFixed(2)}%</td>
                </tr>`).join("") + "</tbody></table></div>";
            contentEl.innerHTML = table;
            initializeChart(data[0].symbol); // نمودار ارز اول
          })
          .catch(() => contentEl.innerHTML = "<p>خطا در دریافت اطلاعات!</p>");
        
        document.getElementById("currencySelect").addEventListener("change", (e) => {
          const selectedSymbol = e.target.value;
          initializeChart(selectedSymbol);
        });
      }
      if (index === 1) {
        contentEl.innerHTML = "<p>در حال بارگذاری اخبار...</p>";
        fetch("https://amyrgit-production.up.railway.app/news")
          .then(res => res.json())
          .then(news => {
            const html = news.map(item => `
              <div style="margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px">
                <img src="${item.image}" style="max-width:100%;border-radius:12px" />
                <h3>${item.title}</h3>
                <p>${item.summary}</p>
                <a href="${item.link}" target="_blank" style="color:#00cec9">ادامه خبر</a>
              </div>`).join("");
            contentEl.innerHTML = html;
          })
          .catch(() => contentEl.innerHTML = "<p>خطا در دریافت اخبار!</p>");
      }
      if (index === 2) {
        loadTelegramUser(userId => {
          contentEl.innerHTML = "<p>در حال دریافت اطلاعات...</p>";
          fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
            .then(res => res.json())
            .then(data => {
              if (data.ref_code) {
                const html = `
                  <h2>لینک دعوت شما</h2>
                  <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
                  <p>امتیاز شما: ${data.points}</p>
                  <p>افراد دعوت‌شده:</p>
                  <ul>${data.invited.map(id => `<li>${id}</li>`).join("")}</ul>`;
                contentEl.innerHTML = html;
              } else contentEl.innerHTML = "<p>داده‌ای برای نمایش وجود ندارد.</p>";
            })
            .catch(() => contentEl.innerHTML = "<p>خطا در دریافت داده‌ها!</p>");
        });
      }
      if (index === 3) {
        loadTelegramUser(userId => {
          const html = `
            <h2>ثبت قرارداد جدید</h2>
            <label>مبلغ (USDT):</label>
            <input type="number" id="amount" />
            <label>تاریخ پایان:</label>
            <select id="due">${[7, 14, 21, 28].map(d => `<option value="${d}">${d} روز</option>`).join("")}</select>
            <label>توضیحات:</label>
            <textarea id="desc" rows="3"></textarea>
            <button onclick="submitContract('${userId}')">ثبت قرارداد</button>
            <div id="contracts"></div>`;
          contentEl.innerHTML = html;
        });
      }
      if (index === 4) {
        loadTelegramUser(userId => {
          contentEl.innerHTML = "<p>در حال دریافت کیف پول...</p>";
          fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
            .then(res => res.json())
            .then(wallet => {
              const html = wallet ? `
                <h2>کیف پول شما</h2>
                <p><strong>موجودی:</strong> ${wallet.balance} امتیاز</p>
                <p><strong>تاریخ ایجاد:</strong> ${new Date(wallet.created_at).toLocaleString("fa-IR")}</p>` : "<p>خطا در دریافت کیف پول.</p>";
              contentEl.innerHTML = html;
            })
            .catch(() => contentEl.innerHTML = "<p>خطا در ارتباط با سرور.</p>");
        });
      }
    }
    
    function initializeChart(symbol) {
      new TradingView.widget({
        autosize: true,
        symbol: `BINANCE:${symbol}USDT`,
        interval: "15",
        container_id: "chartContainer",
        datafeed: new Datafeeds.UDFCompatibleDatafeed("https://demo_feed.tradingview.com"),
        library_path: "https://s3.tradingview.com/tv.js",
        locale: "fa",
        disabled_features: ["header_widget", "left_toolbar", "header_compare"],
        enabled_features: ["study_templates"],
        theme: "dark",
        fullscreen: true
      });
    }
    
    function loadTelegramUser(callback) {
      if (window.Telegram && Telegram.WebApp.initDataUnsafe?.user) {
        callback(Telegram.WebApp.initDataUnsafe.user.id);
      } else {
        document.getElementById(`tab-${currentTab}`).innerHTML = "<p>این قابلیت تنها در محیط تلگرام فعال است.</p>";
      }
    }
    
    window.onload = () => {
      loadTab(0);
    };
  </script>
</body>
</html>