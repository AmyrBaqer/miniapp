<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مینی‌اپ ارز دیجیتال</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #121212;
      color: white;
      height: 100%;
      direction: rtl;
    }
    .tab-container {
      position: relative;
      padding-bottom: 70px;
      min-height: 100vh;
    }
    .tab-content {
      display: none;
      padding: 16px;
    }
    .tab-content.active {
      display: block;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1e1e1e;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #333;
      z-index: 1000;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      cursor: pointer;
      color: #aaa;
      font-size: 12px;
      transition: background 0.3s, color 0.3s;
    }
    .tab i {
      display: block;
      font-size: 18px;
      margin-bottom: 2px;
    }
    .tab.active {
      background: #00b894;
      color: #fff;
    }
    select, table, input, textarea, button {
      background: #222;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    button {
      background: #00b894;
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <div class="tab-container">
    <div class="tab-content" id="tab-0"><p>در حال بارگذاری...</p></div>
    <div class="tab-content" id="tab-1"><p>در حال بارگذاری...</p></div>
    <div class="tab-content" id="tab-2"><p>در حال بارگذاری...</p></div>
    <div class="tab-content" id="tab-3"><p>در حال بارگذاری...</p></div>
    <div class="tab-content" id="tab-4"><p>در حال بارگذاری...</p></div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)"><i class="fas fa-coins"></i>قیمت</div>
    <div class="tab" onclick="switchTab(1)"><i class="fas fa-newspaper"></i>اخبار</div>
    <div class="tab" onclick="switchTab(2)"><i class="fas fa-user-friends"></i>رفرال</div>
    <div class="tab" onclick="switchTab(3)"><i class="fas fa-file-signature"></i>قرارداد</div>
    <div class="tab" onclick="switchTab(4)"><i class="fas fa-wallet"></i>کیف پول</div>
  </div>
  <script>
    let currentTab = 0;
    const loadedTabs = {};

    document.querySelectorAll('.tab-content')[0].classList.add('active');

    function switchTab(index) {
      if (index === currentTab) return;
      document.querySelectorAll('.tab').forEach((tab, i) =>
        tab.classList.toggle("active", i === index)
      );
      document.getElementById(`tab-${currentTab}`).classList.remove("active");
      document.getElementById(`tab-${index}`).classList.add("active");
      currentTab = index;
      if (!loadedTabs[index]) {
        loadTab(index);
        loadedTabs[index] = true;
      }
    }

    function saveContent(index, html) {
      sessionStorage.setItem("tab_" + index, html);
    }

    function loadTelegramUser(callback) {
      if (window.Telegram && Telegram.WebApp.initDataUnsafe?.user) {
        callback(Telegram.WebApp.initDataUnsafe.user.id);
      } else {
        document.getElementById(`tab-${currentTab}`).innerHTML = "<p>این قابلیت تنها در تلگرام فعال است.</p>";
      }
    }

    function loadTab(index) {
      const el = document.getElementById(`tab-${index}`);
      if (index === 0) {
        fetch("https://mnymaker-production.up.railway.app/crypto")
          .then(res => res.json())
          .then(data => {
            const options = data.map(c => `<option>${c.name}</option>`).join("");
            const table = `<table><thead><tr><th>نام</th><th>قیمت</th><th>تغییر ۲۴ساعته</th></tr></thead><tbody>` +
              data.map(c => `<tr><td>${c.name}</td><td>$${c.price}</td><td style="color:${c.change>=0?"lightgreen":"salmon"}">${c.change.toFixed(2)}%</td></tr>`).join("") +
              `</tbody></table>`;
            el.innerHTML = `<label>انتخاب ارز:</label><select>${options}</select>${table}`;
          });
      }
      if (index === 1) {
        fetch("https://amyrgit-production.up.railway.app/news")
          .then(res => res.json())
          .then(news => {
            el.innerHTML = news.map(item => `
              <div style="margin-bottom:20px;border-bottom:1px solid #444;padding-bottom:10px">
                <img src="${item.image}" style="max-width:100%;border-radius:12px" />
                <h3>${item.title}</h3>
                <p>${item.summary}</p>
                <a href="${item.link}" target="_blank" style="color:#00cec9">ادامه خبر</a>
              </div>`).join("");
          });
      }
      if (index === 2) {
        loadTelegramUser(userId => {
          fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
            .then(res => res.json())
            .then(data => {
              if (data.ref_code) {
                el.innerHTML = `
                  <h2>لینک دعوت شما</h2>
                  <input value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" readonly />
                  <p>امتیاز شما: ${data.points}</p>
                  <p>افراد دعوت‌شده:</p>
                  <ul>${data.invited.map(id => `<li>${id}</li>`).join("")}</ul>`;
              }
            });
        });
      }
      if (index === 3) {
        loadTelegramUser(userId => {
          el.innerHTML = `
            <h2>ثبت قرارداد جدید</h2>
            <label>مبلغ (USDT):</label>
            <input type="number" id="amount" />
            <label>تاریخ پایان:</label>
            <select id="due">${[7,14,21,28].map(d => `<option value="${d}">${d} روز</option>`).join("")}</select>
            <label>توضیحات:</label>
            <textarea id="desc" rows="3"></textarea>
            <button onclick="submitContract('${userId}')">ثبت قرارداد</button>
            <div id="contracts"></div>`;
          loadContracts(userId);
        });
      }
      if (index === 4) {
        loadTelegramUser(userId => {
          fetch(`https://walletapp-production-ccf1.up.railway.app/wallet?user_id=${userId}`)
            .then(res => res.json())
            .then(wallet => {
              el.innerHTML = wallet ? `
                <h2>کیف پول شما</h2>
                <p><strong>موجودی:</strong> ${wallet.balance} امتیاز</p>
                <p><strong>تاریخ ایجاد:</strong> ${new Date(wallet.created_at).toLocaleString("fa-IR")}</p>` : "<p>کیف پول یافت نشد.</p>";
            });
        });
      }
    }

    function submitContract(userId) {
      const amount = document.getElementById("amount").value;
      const due = document.getElementById("due").value;
      const desc = document.getElementById("desc").value;
      fetch("https://mnymaker-production.up.railway.app/contract/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, amount, due_days: due, description: desc })
      })
        .then(res => res.json())
        .then(() => switchTab(3))
        .catch(() => document.getElementById("contracts").innerHTML += "<p>خطا در ثبت قرارداد!</p>");
    }

    function loadContracts(userId) {
      fetch(`https://mnymaker-production.up.railway.app/contract/list?user_id=${userId}`)
        .then(res => res.json())
        .then(contracts => {
          const table = `
            <h2>لیست قراردادها</h2>
            <table><thead><tr><th>مبلغ</th><th>تاریخ</th><th>توضیحات</th><th>وضعیت</th></tr></thead><tbody>` +
            contracts.map(c => `<tr><td>${c.amount} USDT</td><td>${c.due_date}</td><td>${c.description}</td><td>${c.status}</td></tr>`).join("") +
            `</tbody></table>`;
          document.getElementById("contracts").innerHTML = table;
        });
    }

    window.onload = () => {
      loadTab(0);
      loadedTabs[0] = true;
    };
  </script>
</body>
</html>