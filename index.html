<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مینی‌اپ ارز دیجیتال</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      margin: 0;
      background: #121212;
      color: #fff;
      padding-bottom: 70px;
      direction: rtl;
      height: 100vh;
      overflow: hidden;
    }
    .tab-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    .tab-content {
      width: 100%;
      padding: 16px;
      text-align: center;
      position: absolute;
      top: 0;
      right: 0;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      height: calc(100% - 60px);
      overflow-y: auto;
      background: #121212;
    }
    .tab-content.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }
    .tabs {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 100%;
      background: #1e1e1e;
      display: flex;
      flex-direction: row-reverse;
      border-top: 1px solid #333;
      z-index: 1000;
      padding: 0px 0;
      height: 70px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 0px 0;
      cursor: pointer;
      color: #aaa;
      font-size: 12.96px;
      transition: all 0.3s ease;
      border-radius: 12px 12px 0 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .tab i {
      display: block;
      font-size: 20.9952px;
      margin-bottom: 2px;
    }
    .tab.active {
      background: #00b894;
      color: #fff;
      padding: 11.664px 0;
      z-index: 1001;
      position: relative;
      transform: translateY(-5px);
      height: 108%; 
    }
    select, table, input, textarea, button {
      background: #222;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    .currency-select-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      margin-top: 0;
    }
    .currency-select-container label {
      margin: 0;
      white-space: nowrap;
      font-size: 130%;
      position: relative;
      top: -15%;
    }
    .currency-select-container select {
      flex: 1;
    }
    select {
      text-align: center;
      direction: ltr;
      font-size: 105%;
    }
    table { 
      border-collapse: collapse; 
      margin-top: 10px; 
      width: 100%;
      direction: ltr;
    }
    th {
      position: sticky;
      top: 0;
      background: #222;
      z-index: 1;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    td:first-child {
      width: 40%;
    }
    td:nth-child(2), td:nth-child(3) {
      width: 30%;
    }
    button { 
      background: #00b894; 
      cursor: pointer; 
      transition: opacity 0.3s;
    }
    button:hover {
      opacity: 0.9;
    }
    .scrollable { 
      max-height: 360px; 
      overflow-y: auto;
      margin-top: 0;
    }
    .tradingview-widget-container {
      width: 100%;
      height: 300px;
      margin-bottom: 0;
      border-radius: 12px;
      overflow: hidden;
    }
    #tradingview-widget {
      width: 100%;
      height: 100%;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }
    .loading:after {
      content: " ";
      display: block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 3px solid #fff;
      border-color: #fff transparent #fff transparent;
      animation: loading 1.2s linear infinite;
    }
    @keyframes loading {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      color: #ff6b6b;
      padding: 10px;
      background: #2d2d2d;
      border-radius: 8px;
      margin: 10px 0;
    }
    .language-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #1e1e1e;
      border-radius: 12px;
    }
    .language-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .language-selector label {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="tab-container">
    <div class="tab-content active" id="tab-0">
      <div class="currency-select-container">
        <label data-translate-key="selectCurrency"></label>
        <select id="currencySelect" onchange="updateTradingViewWidget(this.value)">
          <option value="TON" selected>TonCoin</option>
        </select>
      </div>
      <div class="tradingview-widget-container">
        <div id="tradingview-widget"></div>
      </div>
      <div id="crypto-table-container" class="scrollable">
        <p data-translate-key="fetchingMarketData"></p>
      </div>
    </div>
    <div class="tab-content" id="tab-1">
      <div class="loading" data-translate-key="fetchingNews"></div>
    </div>
    <div class="tab-content" id="tab-2">
      <h2 data-translate-key="referralSystem"></h2>
      <p data-translate-key="inviteLinkCopied"></p>
    </div>
    <div class="tab-content" id="tab-3">
      <h2 data-translate-key="manageContracts"></h2>
      <label data-translate-key="amount"></label>
      <input type="number" id="amount" placeholder="" data-translate-placeholder="amountPlaceholder">
      <label data-translate-key="dueDate"></label>
      <select id="due">
        <option value="7" data-translate-key="days7"></option>
        <option value="14" data-translate-key="days14"></option>
        <option value="21" data-translate-key="days21"></option>
        <option value="28" data-translate-key="days28"></option>
      </select>
      <label data-translate-key="description"></label>
      <textarea id="desc" rows="3" data-translate-placeholder="descriptionPlaceholder"></textarea>
      <button onclick="submitContract()" data-translate-key="registerContract"></button>
    </div>
    <div class="tab-content" id="tab-4">
      <div class="language-section">
        <div class="language-selector">
          <label data-translate-key="selectLanguage"></label>
          <select id="languageSelect" onchange="setLanguage(this.value)" style="flex:1">
            <option value="fa">فارسی</option>
            <option value="en">English</option>
            <option value="es">Español</option>
            <option value="zh">中文</option>
            <option value="hi">हिन्दी</option>
            <option value="ar">العربية</option>
            <option value="ru">Русский</option>
            <option value="pt">Português</option>
            <option value="fr">Français</option>
          </select>
        </div>
      </div>
      <div style="background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
        <p id="wallet-balance-label" data-translate-key="walletBalance"></p>
        <p style="font-size: 32px; font-weight: bold; margin: 0; color: #00b894;">0 <span style="font-size: 16px;" data-translate-key="points"></span></p>
      </div>
      <div style="background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
        <h3 id="recent-transactions-label" data-translate-key="recentTransactions"></h3>
        <p data-translate-key="noTransactions"></p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button style="flex: 1; background: #00b894;" data-translate-key="deposit"></button>
        <button style="flex: 1; background: #fc5c65;" data-translate-key="withdraw"></button>
      </div>
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">
      <i class="fas fa-coins"></i>
      <span data-translate-key="price"></span>
    </div>
    <div class="tab" onclick="switchTab(1)">
      <i class="fas fa-newspaper"></i>
      <span data-translate-key="news"></span>
    </div>
    <div class="tab" onclick="switchTab(2)">
      <i class="fas fa-user-friends"></i>
      <span data-translate-key="referral"></span>
    </div>
    <div class="tab" onclick="switchTab(3)">
      <i class="fas fa-file-signature"></i>
      <span data-translate-key="contract"></span>
    </div>
    <div class="tab" onclick="switchTab(4)">
      <i class="fas fa-wallet"></i>
      <span data-translate-key="wallet"></span>
    </div>
  </div>

  <script>
    let appLanguage = 'fa';
    let currentTab = 0;
    const loadedTabs = {};
    const tabEls = document.querySelectorAll('.tab-content');
    let tradingViewScriptLoaded = false;

    const translations = {
      fa: {
        price: 'قیمت',
        news: 'اخبار',
        referral: 'رفرال',
        contract: 'قرارداد',
        wallet: 'کیف پول',
        selectCurrency: 'انتخاب ارز:',
        currencyName: 'نام ارز',
        change24h: 'تغییر 24ساعت',
        referralSystem: 'سیستم معرفی دوستان',
        manageContracts: 'مدیریت قراردادها',
        amount: 'مبلغ (USDT):',
        amountPlaceholder: 'مثال: 100',
        dueDate: 'تاریخ پایان:',
        description: 'توضیحات:',
        descriptionPlaceholder: 'توضیحات قرارداد (اختیاری)',
        days7: '7 روز',
        days14: '14 روز',
        days21: '21 روز',
        days28: '28 روز',
        registerContract: 'ثبت قرارداد',
        selectLanguage: 'انتخاب زبان:',
        walletBalance: 'موجودی فعلی',
        points: 'امتیاز',
        recentTransactions: 'تراکنش‌های اخیر',
        deposit: 'واریز',
        withdraw: 'برداشت',
        noTransactions: 'تراکنشی یافت نشد',
        inviteLinkCopied: 'لینک دعوت کپی شد!',
        enterValidAmount: 'لطفاً مبلغ معتبر وارد کنید',
        registeringContract: 'در حال ثبت قرارداد...',
        contractRegistered: 'قرارداد با موفقیت ثبت شد!',
        noContracts: 'قرارداد فعالی وجود ندارد',
        fetchingMarketData: 'در حال دریافت اطلاعات بازار...',
        noMarketData: 'داده‌ای برای نمایش وجود ندارد',
        fetchingNews: 'در حال دریافت اخبار...',
        noNews: 'اخبار جدیدی یافت نشد',
        errorLoadingChart: 'خطا در نمایش نمودار',
        errorFetchingData: 'خطا در دریافت اطلاعات بازار',
        errorFetchingNews: 'خطا در دریافت اخبار',
        errorFetchingContracts: 'خطا در دریافت قراردادها',
        errorFetchingReferral: 'خطا در دریافت اطلاعات معرفی',
        errorConnectingServer: 'خطا در ارتباط با سرور'
      },
      en: {
        price: 'Price',
        news: 'News',
        referral: 'Referral',
        contract: 'Contract',
        wallet: 'Wallet',
        selectCurrency: 'Select Currency:',
        currencyName: 'Currency Name',
        change24h: '24h Change',
        referralSystem: 'Referral System',
        manageContracts: 'Manage Contracts',
        amount: 'Amount (USDT):',
        amountPlaceholder: 'Example: 100',
        dueDate: 'Due Date:',
        description: 'Description:',
        descriptionPlaceholder: 'Contract description (optional)',
        days7: '7 days',
        days14: '14 days',
        days21: '21 days',
        days28: '28 days',
        registerContract: 'Register Contract',
        selectLanguage: 'Select Language:',
        walletBalance: 'Current Balance',
        points: 'Points',
        recentTransactions: 'Recent Transactions',
        deposit: 'Deposit',
        withdraw: 'Withdraw',
        noTransactions: 'No transactions found',
        inviteLinkCopied: 'Invite link copied!',
        enterValidAmount: 'Please enter a valid amount',
        registeringContract: 'Registering contract...',
        contractRegistered: 'Contract successfully registered!',
        noContracts: 'No active contracts',
        fetchingMarketData: 'Fetching market data...',
        noMarketData: 'No data available',
        fetchingNews: 'Fetching news...',
        noNews: 'No news found',
        errorLoadingChart: 'Error loading chart',
        errorFetchingData: 'Error fetching market data',
        errorFetchingNews: 'Error fetching news',
        errorFetchingContracts: 'Error fetching contracts',
        errorFetchingReferral: 'Error fetching referral data',
        errorConnectingServer: 'Error connecting to server'
      },
      es: {
        price: 'Precio',
        news: 'Noticias',
        referral: 'Referidos',
        contract: 'Contrato',
        wallet: 'Cartera',
        selectCurrency: 'Seleccionar moneda:',
        currencyName: 'Nombre de moneda',
        change24h: 'Cambio 24h',
        referralSystem: 'Sistema de referidos',
        manageContracts: 'Administrar contratos',
        amount: 'Cantidad (USDT):',
        amountPlaceholder: 'Ejemplo: 100',
        dueDate: 'Fecha de vencimiento:',
        description: 'Descripción:',
        descriptionPlaceholder: 'Descripción del contrato (opcional)',
        days7: '7 días',
        days14: '14 días',
        days21: '21 días',
        days28: '28 días',
        registerContract: 'Registrar contrato',
        selectLanguage: 'Seleccionar idioma:',
        walletBalance: 'Saldo actual',
        points: 'Puntos',
        recentTransactions: 'Transacciones recientes',
        deposit: 'Depósito',
        withdraw: 'Retiro',
        noTransactions: 'No se encontraron transacciones',
        inviteLinkCopied: '¡Enlace de invitación copiado!',
        enterValidAmount: 'Por favor ingrese un monto válido',
        registeringContract: 'Registrando contrato...',
        contractRegistered: '¡Contrato registrado con éxito!',
        noContracts: 'No hay contratos activos',
        fetchingMarketData: 'Obteniendo datos del mercado...',
        noMarketData: 'No hay datos disponibles',
        fetchingNews: 'Obteniendo noticias...',
        noNews: 'No se encontraron noticias',
        errorLoadingChart: 'Error al cargar el gráfico',
        errorFetchingData: 'Error al obtener datos del mercado',
        errorFetchingNews: 'Error al obtener noticias',
        errorFetchingContracts: 'Error al obtener contratos',
        errorFetchingReferral: 'Error al obtener datos de referencia',
        errorConnectingServer: 'Error al conectar con el servidor'
      },
      zh: {
        price: '价格',
        news: '新闻',
        referral: '推荐',
        contract: '合同',
        wallet: '钱包',
        selectCurrency: '选择货币:',
        currencyName: '货币名称',
        change24h: '24小时变化',
        referralSystem: '推荐系统',
        manageContracts: '管理合同',
        amount: '金额 (USDT):',
        amountPlaceholder: '例如: 100',
        dueDate: '到期日期:',
        description: '描述:',
        descriptionPlaceholder: '合同描述 (可选)',
        days7: '7天',
        days14: '14天',
        days21: '21天',
        days28: '28天',
        registerContract: '注册合同',
        selectLanguage: '选择语言:',
        walletBalance: '当前余额',
        points: '积分',
        recentTransactions: '最近交易',
        deposit: '存款',
        withdraw: '取款',
        noTransactions: '未找到交易',
        inviteLinkCopied: '邀请链接已复制!',
        enterValidAmount: '请输入有效金额',
        registeringContract: '正在注册合同...',
        contractRegistered: '合同注册成功!',
        noContracts: '没有活跃合同',
        fetchingMarketData: '正在获取市场数据...',
        noMarketData: '没有可用数据',
        fetchingNews: '正在获取新闻...',
        noNews: '未找到新闻',
        errorLoadingChart: '加载图表错误',
        errorFetchingData: '获取市场数据错误',
        errorFetchingNews: '获取新闻错误',
        errorFetchingContracts: '获取合同错误',
        errorFetchingReferral: '获取推荐数据错误',
        errorConnectingServer: '连接服务器错误'
      },
      hi: {
        price: 'कीमत',
        news: 'समाचार',
        referral: 'रेफरल',
        contract: 'अनुबंध',
        wallet: 'वॉलेट',
        selectCurrency: 'मुद्रा चुनें:',
        currencyName: 'मुद्रा का नाम',
        change24h: '24 घंटे में परिवर्तन',
        referralSystem: 'रेफरल प्रणाली',
        manageContracts: 'अनुबंध प्रबंधित करें',
        amount: 'राशि (USDT):',
        amountPlaceholder: 'उदाहरण: 100',
        dueDate: 'नियत तारीख:',
        description: 'विवरण:',
        descriptionPlaceholder: 'अनुबंध विवरण (वैकल्पिक)',
        days7: '7 दिन',
        days14: '14 दिन',
        days21: '21 दिन',
        days28: '28 दिन',
        registerContract: 'अनुबंध पंजीकृत करें',
        selectLanguage: 'भाषा चुनें:',
        walletBalance: 'वर्तमान शेष',
        points: 'अंक',
        recentTransactions: 'हाल के लेन-देन',
        deposit: 'जमा',
        withdraw: 'निकासी',
        noTransactions: 'कोई लेन-देन नहीं मिला',
        inviteLinkCopied: 'आमंत्रण लिंक कॉपी किया गया!',
        enterValidAmount: 'कृपया एक मान्य राशि दर्ज करें',
        registeringContract: 'अनुबंध पंजीकृत किया जा रहा है...',
        contractRegistered: 'अनुबंध सफलतापूर्वक पंजीकृत!',
        noContracts: 'कोई सक्रिय अनुबंध नहीं',
        fetchingMarketData: 'बाजार डेटा प्राप्त किया जा रहा है...',
        noMarketData: 'कोई डेटा उपलब्ध नहीं',
        fetchingNews: 'समाचार प्राप्त किए जा रहे हैं...',
        noNews: 'कोई समाचार नहीं मिला',
        errorLoadingChart: 'चार्ट लोड करने में त्रुटि',
        errorFetchingData: 'बाजार डेटा प्राप्त करने में त्रुटि',
        errorFetchingNews: 'समाचार प्राप्त करने में त्रुटि',
        errorFetchingContracts: 'अनुबंध प्राप्त करने में त्रुटि',
        errorFetchingReferral: 'रेफरल डेटा प्राप्त करने में त्रुटि',
        errorConnectingServer: 'सर्वर से कनेक्ट करने में त्रुटि'
      },
      ar: {
        price: 'السعر',
        news: 'الأخبار',
        referral: 'الإحالة',
        contract: 'العقد',
        wallet: 'المحفظة',
        selectCurrency: 'اختر العملة:',
        currencyName: 'اسم العملة',
        change24h: 'تغيير 24 ساعة',
        referralSystem: 'نظام الإحالة',
        manageContracts: 'إدارة العقود',
        amount: 'المبلغ (USDT):',
        amountPlaceholder: 'مثال: 100',
        dueDate: 'تاريخ الاستحقاق:',
        description: 'الوصف:',
        descriptionPlaceholder: 'وصف العقد (اختياري)',
        days7: '7 أيام',
        days14: '14 يومًا',
        days21: '21 يومًا',
        days28: '28 يومًا',
        registerContract: 'تسجيل العقد',
        selectLanguage: 'اختر اللغة:',
        walletBalance: 'الرصيد الحالي',
        points: 'النقاط',
        recentTransactions: 'المعاملات الأخيرة',
        deposit: 'إيداع',
        withdraw: 'سحب',
        noTransactions: 'لم يتم العثور على معاملات',
        inviteLinkCopied: 'تم نسخ رابط الدعوة!',
        enterValidAmount: 'الرجاء إدخال مبلغ صالح',
        registeringContract: 'جارٍ تسجيل العقد...',
        contractRegistered: 'تم تسجيل العقد بنجاح!',
        noContracts: 'لا توجد عقود نشطة',
        fetchingMarketData: 'جارٍ جلب بيانات السوق...',
        noMarketData: 'لا توجد بيانات متاحة',
        fetchingNews: 'جارٍ جلب الأخبار...',
        noNews: 'لم يتم العثور على أخبار',
        errorLoadingChart: 'خطأ في تحميل الرسم البياني',
        errorFetchingData: 'خطأ في جلب بيانات السوق',
        errorFetchingNews: 'خطأ في جلب الأخبار',
        errorFetchingContracts: 'خطأ في جلب العقود',
        errorFetchingReferral: 'خطأ في جلب بيانات الإحالة',
        errorConnectingServer: 'خطأ في الاتصال بالخادم'
      },
      ru: {
        price: 'Цена',
        news: 'Новости',
        referral: 'Реферал',
        contract: 'Контракт',
        wallet: 'Кошелек',
        selectCurrency: 'Выберите валюту:',
        currencyName: 'Название валюты',
        change24h: 'Изменение за 24ч',
        referralSystem: 'Реферальная система',
        manageContracts: 'Управление контрактами',
        amount: 'Сумма (USDT):',
        amountPlaceholder: 'Пример: 100',
        dueDate: 'Срок действия:',
        description: 'Описание:',
        descriptionPlaceholder: 'Описание контракта (необязательно)',
        days7: '7 дней',
        days14: '14 дней',
        days21: '21 день',
        days28: '28 дней',
        registerContract: 'Зарегистрировать контракт',
        selectLanguage: 'Выберите язык:',
        walletBalance: 'Текущий баланс',
        points: 'Очки',
        recentTransactions: 'Последние транзакции',
        deposit: 'Депозит',
        withdraw: 'Снять',
        noTransactions: 'Транзакции не найдены',
        inviteLinkCopied: 'Ссылка на приглашение скопирована!',
        enterValidAmount: 'Пожалуйста, введите действительную сумму',
        registeringContract: 'Регистрация контракта...',
        contractRegistered: 'Контракт успешно зарегистрирован!',
        noContracts: 'Активных контрактов нет',
        fetchingMarketData: 'Получение данных рынка...',
        noMarketData: 'Нет доступных данных',
        fetchingNews: 'Получение новостей...',
        noNews: 'Новостей не найдено',
        errorLoadingChart: 'Ошибка загрузки графика',
        errorFetchingData: 'Ошибка получения данных рынка',
        errorFetchingNews: 'Ошибка получения новостей',
        errorFetchingContracts: 'Ошибка получения контрактов',
        errorFetchingReferral: 'Ошибка получения данных рефералов',
        errorConnectingServer: 'Ошибка подключения к серверу'
      },
      pt: {
        price: 'Preço',
        news: 'Notícias',
        referral: 'Indicação',
        contract: 'Contrato',
        wallet: 'Carteira',
        selectCurrency: 'Selecione a moeda:',
        currencyName: 'Nome da moeda',
        change24h: 'Mudança 24h',
        referralSystem: 'Sistema de indicação',
        manageContracts: 'Gerenciar contratos',
        amount: 'Quantidade (USDT):',
        amountPlaceholder: 'Exemplo: 100',
        dueDate: 'Data de vencimento:',
        description: 'Descrição:',
        descriptionPlaceholder: 'Descrição do contrato (opcional)',
        days7: '7 dias',
        days14: '14 dias',
        days21: '21 dias',
        days28: '28 dias',
        registerContract: 'Registrar contrato',
        selectLanguage: 'Selecione o idioma:',
        walletBalance: 'Saldo atual',
        points: 'Pontos',
        recentTransactions: 'Transações recentes',
        deposit: 'Depósito',
        withdraw: 'Saque',
        noTransactions: 'Nenhuma transação encontrada',
        inviteLinkCopied: 'Link de convite copiado!',
        enterValidAmount: 'Por favor, insira um valor válido',
        registeringContract: 'Registrando contrato...',
        contractRegistered: 'Contrato registrado com sucesso!',
        noContracts: 'Nenhum contrato ativo',
        fetchingMarketData: 'Obtendo dados do mercado...',
        noMarketData: 'Nenhum dado disponível',
        fetchingNews: 'Obtendo notícias...',
        noNews: 'Nenhuma notícia encontrada',
        errorLoadingChart: 'Erro ao carregar gráfico',
        errorFetchingData: 'Erro ao obter dados do mercado',
        errorFetchingNews: 'Erro ao obter notícias',
        errorFetchingContracts: 'Erro ao obter contratos',
        errorFetchingReferral: 'Erro ao obter dados de indicação',
        errorConnectingServer: 'Erro ao conectar ao servidor'
      },
      fr: {
        price: 'Prix',
        news: 'Actualités',
        referral: 'Parrainage',
        contract: 'Contrat',
        wallet: 'Portefeuille',
        selectCurrency: 'Sélectionnez la devise:',
        currencyName: 'Nom de la devise',
        change24h: 'Changement 24h',
        referralSystem: 'Système de parrainage',
        manageContracts: 'Gérer les contrats',
        amount: 'Montant (USDT):',
        amountPlaceholder: 'Exemple: 100',
        dueDate: 'Date d\'échéance:',
        description: 'Description:',
        descriptionPlaceholder: 'Description du contrat (optionnelle)',
        days7: '7 jours',
        days14: '14 jours',
        days21: '21 jours',
        days28: '28 jours',
        registerContract: 'Enregistrer le contrat',
        selectLanguage: 'Sélectionnez la langue:',
        walletBalance: 'Solde actuel',
        points: 'Points',
        recentTransactions: 'Transactions récentes',
        deposit: 'Dépôt',
        withdraw: 'Retrait',
        noTransactions: 'Aucune transaction trouvée',
        inviteLinkCopied: 'Lien d\'invitation copié!',
        enterValidAmount: 'Veuillez entrer un montant valide',
        registeringContract: 'Enregistrement du contrat...',
        contractRegistered: 'Contrat enregistré avec succès!',
        noContracts: 'Aucun contrat actif',
        fetchingMarketData: 'Récupération des données du marché...',
        noMarketData: 'Aucune donnée disponible',
        fetchingNews: 'Récupération des actualités...',
        noNews: 'Aucune actualité trouvée',
        errorLoadingChart: 'Erreur de chargement du graphique',
        errorFetchingData: 'Erreur lors de la récupération des données du marché',
        errorFetchingNews: 'Erreur lors de la récupération des actualités',
        errorFetchingContracts: 'Erreur lors de la récupération des contrats',
        errorFetchingReferral: 'Erreur lors de la récupération des données de parrainage',
        errorConnectingServer: 'Erreur de connexion au serveur'
      }
    };

    function setLanguage(lang) {
      appLanguage = lang;
      document.documentElement.lang = lang;
      document.getElementById('languageSelect').value = lang;
      updateLanguageTexts();
    }

    function detectUserLanguage() {
      const userLang = navigator.language || navigator.userLanguage;
      const supportedLangs = ['fa', 'en', 'es', 'zh', 'hi', 'ar', 'ru', 'pt', 'fr'];
      const primaryLang = userLang.split('-')[0];

      if (supportedLangs.includes(primaryLang)) {
        setLanguage(primaryLang);
      } else {
        setLanguage('fa');
      }
    }

    function updateLanguageTexts() {
      const texts = translations[appLanguage];
      
      // Update all elements with data-translate-key
      document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.getAttribute('data-translate-key');
        if (texts[key]) {
          el.textContent = texts[key];
        }
      });
      
      // Update placeholder texts
      document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        if (texts[key]) {
          el.placeholder = texts[key];
        }
      });
      
      // Update tab labels
      document.querySelectorAll('.tab').forEach((tab, index) => {
        const labels = [texts.price, texts.news, texts.referral, texts.contract, texts.wallet];
        const span = tab.querySelector('span');
        if (span) span.textContent = labels[index];
      });
      
      // Update table headers if table exists
      const tableHeaders = document.querySelectorAll('th');
      if (tableHeaders.length >= 3) {
        tableHeaders[0].textContent = texts.currencyName || 'Currency';
        tableHeaders[1].textContent = texts.price || 'Price';
        tableHeaders[2].textContent = texts.change24h || '24h Change';
      }
    }

    function loadTradingViewScript(callback) {
      if (typeof TradingView !== 'undefined') {
        tradingViewScriptLoaded = true;
        if (callback) callback();
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://s3.tradingview.com/tv.js';
      script.onload = () => {
        tradingViewScriptLoaded = true;
        if (callback) callback();
      };
      script.onerror = () => {
        console.error('Failed to load TradingView script');
        document.getElementById('tradingview-widget')?.insertAdjacentHTML('afterend', 
          `<p class="error-message">${translations[appLanguage].errorLoadingChart}</p>`);
      };
      document.body.appendChild(script);
    }

    function initializeTradingViewWidget(symbol = 'TON') {
      if (!tradingViewScriptLoaded) {
        loadTradingViewScript(() => initializeTradingViewWidget(symbol));
        return;
      }

      const widgetContainer = document.getElementById("tradingview-widget");
      if (!widgetContainer) return;

      widgetContainer.innerHTML = '<div class="loading"></div>';

      try {
        new TradingView.widget({
          "autosize": false,
          "width": "100%",
          "height": 300,
          "symbol": `${symbol}USDT`,
          "interval": "4H",
          "timezone": "Asia/Tehran",
          "theme": "dark",
          "style": "2",
          "locale": appLanguage === 'fa' ? 'fa_IR' : 'en',
          "toolbar_bg": "#1e1e1e",
          "enable_publishing": false,
          "hide_legend": true,
          "hide_top_toolbar": true,
          "hide_side_toolbar": true,
          "save_image": false,
          "allow_symbol_change": false,
          "hide_volume": true,
          "container_id": "tradingview-widget",
          "studies": []
        });
      } catch (error) {
        console.error('TradingView error:', error);
        widgetContainer.innerHTML = `<p class="error-message">${translations[appLanguage].errorLoadingChart}</p>`;
      }
    }

    function updateTradingViewWidget(symbol) {
      if (typeof symbol !== 'string' || !symbol.trim()) {
        console.error('Invalid symbol:', symbol);
        return;
      }
      initializeTradingViewWidget(symbol);
    }

    function switchTab(index) {
      if (index === currentTab) return;

      tabEls[currentTab].classList.remove("active");
      document.querySelectorAll('.tab').forEach((tab, i) =>
        tab.classList.toggle("active", i === index)
      );

      setTimeout(() => {
        tabEls[index].classList.add("active");
      }, 50);

      currentTab = index;

      if (!loadedTabs[index]) {
        loadTab(index);
        loadedTabs[index] = true;
      }
    }

    function loadTab(index) {
      const contentEl = document.getElementById(`tab-${index}`);
      
      if (index === 0) {
        loadPriceTab(contentEl);
      } else if (index === 1) {
        loadNewsTab(contentEl);
      } else if (index === 2) {
        loadReferralTab(contentEl);
      } else if (index === 3) {
        loadContractTab(contentEl);
      } else if (index === 4) {
        loadWalletTab(contentEl);
      }
    }

    function loadPriceTab(contentEl) {
      contentEl.innerHTML = `
        <div class="currency-select-container">
          <label data-translate-key="selectCurrency"></label>
          <select id="currencySelect" onchange="updateTradingViewWidget(this.value)">
            <option value="TON" selected>TonCoin</option>
          </select>
        </div>
        <div class="tradingview-widget-container">
          <div id="tradingview-widget"></div>
        </div>
        <div id="crypto-table-container" class="scrollable">
          <p data-translate-key="fetchingMarketData"></p>
        </div>`;
      
      initializeTradingViewWidget("TON");

      fetch("https://mnymaker-production.up.railway.app/crypto")
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(data => {
          if (data?.length > 0) {
            const uniqueCurrencies = Array.from(new Map(data.map(c => [c.symbol, c])).values())
              .filter(c => c.symbol !== "USDT" && typeof c.symbol === "string" && typeof c.name === "string" && typeof c.price === "number");

            const options = uniqueCurrencies.map(c => 
              `<option value="${c.symbol}">${c.name}</option>`
            ).join("");

            const tableRows = uniqueCurrencies.map(c => `
              <tr>
                <td>${c.name}</td>
                <td>$${c.price}</td>
                <td style="color:${c.change >= 0 ? "#28B463" : "#E74C3C"}">
                  ${c.change >= 0 ? '▲' : '▼'} ${Math.abs(c.change).toFixed(2)}%
                </td>
              </tr>`
            ).join("");

            document.getElementById("currencySelect").innerHTML = `
              <option value="TON" selected>TonCoin</option>
              ${options}`;

            document.getElementById("crypto-table-container").innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th data-translate-key="currencyName"></th>
                    <th data-translate-key="price"></th>
                    <th data-translate-key="change24h"></th>
                  </tr>
                </thead>
                <tbody>${tableRows}</tbody>
              </table>`;
              
            updateLanguageTexts();
          } else {
            document.getElementById("crypto-table-container").innerHTML = 
              `<p class="error-message">${translations[appLanguage].noMarketData}</p>`;
          }
        })
        .catch(err => {
          console.error("Error fetching crypto data:", err);
          document.getElementById("crypto-table-container").innerHTML = 
            `<p class="error-message">${translations[appLanguage].errorFetchingData}</p>`;
        });
    }

    function loadNewsTab(contentEl) {
      contentEl.innerHTML = `<div class="loading" data-translate-key="fetchingNews"></div>`;
      updateLanguageTexts();
      
      fetch("https://amyrgit-production.up.railway.app/news")
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(news => {
          if (news?.length > 0) {
            contentEl.innerHTML = news.map(item => `
              <div class="news-item" style="
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #333;
              ">
                <img src="${item.image || 'https://via.placeholder.com/300x150?text=No+Image'}" 
                  style="
                    width: 100%;
                    border-radius: 8px;
                    margin-bottom: 10px;
                  "
                  onerror="this.src='https://via.placeholder.com/300x150?text=No+Image'"
                />
                <h3 style="margin: 10px 0;">${item.title}</h3>
                <p style="color: #aaa; margin-bottom: 10px;">${item.summary}</p>
                <a href="${item.link}" target="_blank" style="
                  display: inline-block;
                  padding: 8px 15px;
                  background: #00b894;
                  color: white;
                  border-radius: 8px;
                  text-decoration: none;
                ">
                  ${translations[appLanguage].readMore || 'Read More'}
                </a>
              </div>`
            ).join("");
          } else {
            contentEl.innerHTML = `<p class="error-message">${translations[appLanguage].noNews}</p>`;
          }
        })
        .catch(() => {
          contentEl.innerHTML = `<p class="error-message">${translations[appLanguage].errorFetchingNews}</p>`;
        });
    }

    function loadReferralTab(contentEl) {
      loadTelegramUser(userId => {
        contentEl.innerHTML = `<div class="loading" data-translate-key="fetchingReferral"></div>`;
        updateLanguageTexts();
        
        fetch(`https://mnymaker-production.up.railway.app/referral/join?user_id=${userId}`)
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
          })
          .then(data => {
            if (data.ref_code) {
              contentEl.innerHTML = `
                <h2 style="margin-bottom: 15px;" data-translate-key="referralSystem"></h2>
                
                <div style="
                  background: #1e1e1e;
                  padding: 15px;
                  border-radius: 12px;
                  margin-bottom: 20px;
                ">
                  <p style="margin: 0 0 10px 0;" data-translate-key="yourInviteLink"></p>
                  <input 
                    value="https://t.me/MnyMakr_BOT?start=${data.ref_code}" 
                    readonly
                    style="
                      background: #333;
                      color: white;
                      border: none;
                      padding: 10px;
                      width: 100%;
                      border-radius: 8px;
                      margin-bottom: 10px;
                    "
                  />
                  <button onclick="copyReferralLink()" style="
                    background: #00b894;
                    color: white;
                    border: none;
                    padding: 10px;
                    width: 100%;
                    border-radius: 8px;
                    cursor: pointer;
                  " data-translate-key="copyLink">
                  </button>
                </div>
                
                <div style="
                  background: #1e1e1e;
                  padding: 15px;
                  border-radius: 12px;
                  margin-bottom: 20px;
                ">
                  <p style="margin: 0 0 5px 0; font-size: 18px;">
                    <span data-translate-key="yourPoints"></span>: <strong>${data.points || 0}</strong>
                  </p>
                  <p style="margin: 0; color: #aaa;">
                    <span data-translate-key="perSuccessfulInvite"></span>: +10 <span data-translate-key="points"></span>
                  </p>
                </div>
                
                <div style="
                  background: #1e1e1e;
                  padding: 15px;
                  border-radius: 12px;
                ">
                  <h3 style="margin-top: 0;" data-translate-key="invitedUsers"></h3>
                  ${data.invited?.length > 0 ? 
                    `<ul style="padding-right: 20px;">${
                      data.invited.map(id => `<li style="margin-bottom: 5px;">${id}</li>`).join("")
                    }</ul>` : 
                    `<p style="color: #aaa;" data-translate-key="noInvitedUsers"></p>`
                  }
                </div>`;
                
              updateLanguageTexts();
            } else {
              contentEl.innerHTML = `<p class="error-message">${translations[appLanguage].errorFetchingReferral}</p>`;
            }
          })
          .catch(() => {
            contentEl.innerHTML = `<p class="error-message">${translations[appLanguage].errorConnectingServer}</p>`;
          });
      });
    }

    function loadContractTab(contentEl) {
      loadTelegramUser(userId => {
        contentEl.innerHTML = `
          <h2 style="margin-bottom: 20px;" data-translate-key="manageContracts"></h2>
          
          <div style="
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
          ">
            <h3 style="margin-top: 0;" data-translate-key="registerNewContract"></h3>
            
            <label data-translate-key="amount"></label>
            <input 
              type="number" 
              id="amount" 
              data-translate-placeholder="amountPlaceholder"
            />
            
            <label data-translate-key="dueDate"></label>
            <select id="due">
              <option value="7" data-translate-key="days7"></option>
              <option value="14" data-translate-key="days14"></option>
              <option value="21" data-translate-key="days21"></option>
              <option value="28" data-translate-key="days28"></option>
            </select>
            
            <label data-translate-key="description"></label>
            <textarea 
              id="desc" 
              rows="3" 
              data-translate-placeholder="descriptionPlaceholder"
            ></textarea>
            
            <button onclick="submitContract('${userId}')" data-translate-key="registerContract">
            </button>
          </div>
          
          <div id="contracts-list" style="
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
          ">
            <h3 style="margin-top: 0;" data-translate-key="activeContracts"></h3>
            <p data-translate-key="fetchingContracts"></p>
          </div>`;
          
        updateLanguageTexts();
          
        fetch(`https://mnymaker-production.up.railway.app/contracts?user_id=${userId}`)
          .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
          })
          .then(contracts => {
            const contractsList = document.getElementById("contracts-list");
            
            if (contracts?.length > 0) {
              contractsList.innerHTML = `
                <h3 style="margin-top: 0;" data-translate-key="activeContracts"></h3>
                <div class="scrollable">
                  <table>
                    <thead>
                      <tr>
                        <th data-translate-key="amount"></th>
                        <th data-translate-key="dueDate"></th>
                        <th data-translate-key="status"></th>
                      </tr>
                    </thead>
                    <tbody>
                      ${contracts.map(c => `
                        <tr>
                          <td>${c.amount} USDT</td>
                          <td>${new Date(c.due_date).toLocaleDateString(appLanguage === 'fa' ? 'fa-IR' : 'en-US')}</td>
                          <td style="color: ${
                            c.status === 'active' ? '#26de81' : 
                            c.status === 'pending' ? '#f7b731' : '#fc5c65'
                          }">
                            ${
                              c.status === 'active' ? translations[appLanguage].active : 
                              c.status === 'pending' ? translations[appLanguage].pending : translations[appLanguage].expired
                            }
                          </td>
                        </tr>
                      `).join("")}
                    </tbody>
                  </table>
                </div>`;
            } else {
              contractsList.innerHTML = `<p data-translate-key="noContracts"></p>`;
            }
            updateLanguageTexts();
          })
          .catch(() => {
            document.getElementById("contracts-list").innerHTML = 
              `<p class="error-message">${translations[appLanguage].errorFetchingContracts}</p>`;
          });
      });
    }

    function loadWalletTab(contentEl) {
      contentEl.innerHTML = `
        <div class="language-section">
          <div class="language-selector">
            <label data-translate-key="selectLanguage"></label>
            <select id="languageSelect" onchange="setLanguage(this.value)" style="flex:1">
              <option value="fa">فارسی</option>
              <option value="en">English</option>
              <option value="es">Español</option>
              <option value="zh">中文</option>
              <option value="hi">हिन्दी</option>
              <option value="ar">العربية</option>
              <option value="ru">Русский</option>
              <option value="pt">Português</option>
              <option value="fr">Français</option>
            </select>
          </div>
        </div>
        <div style="background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
          <p id="wallet-balance-label" data-translate-key="walletBalance"></p>
          <p style="font-size: 32px; font-weight: bold; margin: 0; color: #00b894;">0 <span style="font-size: 16px;" data-translate-key="points"></span></p>
        </div>
        <div style="background: #1e1e1e; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
          <h3 id="recent-transactions-label" data-translate-key="recentTransactions"></h3>
          <p data-translate-key="noTransactions"></p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button style="flex: 1; background: #00b894;" data-translate-key="deposit"></button>
          <button style="flex: 1; background: #fc5c65;" data-translate-key="withdraw"></button>
        </div>`;
      
      updateLanguageTexts();
      document.getElementById('languageSelect').value = appLanguage;
    }

    function loadTelegramUser(callback) {
      if (window.Telegram && Telegram.WebApp.initDataUnsafe?.user) {
        callback(Telegram.WebApp.initDataUnsafe.user.id);
      } else {
        const testUserId = Math.floor(Math.random() * 1000000);
        console.warn('Running in test mode with random user ID');
        callback(testUserId);
      }
    }

    function copyReferralLink() {
      const input = document.querySelector('#tab-2 input');
      if (input) {
        input.select();
        document.execCommand('copy');
        alert(translations[appLanguage].inviteLinkCopied);
      }
    }

    function submitContract(userId) {
      const amount = document.getElementById('amount').value;
      const due = document.getElementById('due').value;
      const desc = document.getElementById('desc').value;
      
      if (!amount || isNaN(amount)) {
        alert(translations[appLanguage].enterValidAmount);
        return;
      }
      
      const contractsList = document.getElementById('contracts-list');
      contractsList.innerHTML = `<p>${translations[appLanguage].registeringContract}</p>`;
      
      setTimeout(() => {
        contractsList.innerHTML = `
          <p style="color: #26de81;">${translations[appLanguage].contractRegistered}</p>
          <div class="scrollable">
            <table>
              <thead>
                <tr>
                  <th data-translate-key="amount"></th>
                  <th data-translate-key="dueDate"></th>
                  <th data-translate-key="status"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${amount} USDT</td>
                  <td>${new Date(Date.now() + due * 24 * 60 * 60 * 1000).toLocaleDateString(appLanguage === 'fa' ? 'fa-IR' : 'en-US')}</td>
                  <td style="color: #f7b731;">${translations[appLanguage].pending}</td>
                </tr>
              </tbody>
            </table>
          </div>`;
        updateLanguageTexts();
      }, 1500);
    }

    window.onload = () => {
      detectUserLanguage();
      loadTradingViewScript();
      loadTab(0);
    };
  </script>
</body>
</html>